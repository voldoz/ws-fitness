<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WS Fitness</title>
<style>
  body{margin:0;padding:18px;font-family:Arial,sans-serif;background:linear-gradient(135deg,#0f172a,#1e293b);color:#fff}
  h1{margin:0 0 12px;text-align:center;color:#38bdf8}
  .pill{background:#0b1220;border-radius:14px;padding:10px 12px;display:flex;gap:10px;justify-content:space-between;align-items:center;margin-bottom:12px}
  .pill b{color:#38bdf8}
  .badge{border:1px solid #334155;border-radius:999px;padding:6px 10px;font-size:12px;background:#0b1220}
  .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 14px}
  .tab{flex:1;min-width:120px;border:0;border-radius:12px;padding:12px;font-weight:800;cursor:pointer;background:#1e293b;color:#fff}
  .tab.active{background:linear-gradient(90deg,#0ea5e9,#2563eb)}
  .box{background:#1e293b;border-radius:12px;padding:14px;margin-bottom:12px;line-height:1.7}
  .small{font-size:13px;opacity:.9;margin-top:6px}
  .danger{color:#fecaca}
  .ok{color:#bbf7d0}
  label{display:block;margin-top:12px;font-weight:800}
  select,input{
    width:100%;margin-top:6px;padding:12px;border:0;border-radius:12px;background:#0f172a;color:#fff;font-size:15px;outline:none
  }
  select::-webkit-scrollbar{width:7px}
  select::-webkit-scrollbar-track{background:#0b1220;border-radius:10px}
  select::-webkit-scrollbar-thumb{background:#2563eb;border-radius:10px}
  button.primary{
    width:100%;margin-top:14px;padding:15px;border:0;border-radius:14px;background:linear-gradient(90deg,#0ea5e9,#2563eb);
    color:#fff;font-size:17px;font-weight:900;cursor:pointer
  }
  button.mini{
    width:100%;margin-top:10px;padding:12px;border:0;border-radius:12px;background:#0b1220;color:#fff;font-weight:900;cursor:pointer
  }
  button.red{background:#ef4444 !important}
  .page{display:none}
  .page.active{display:block}
  .hidden{display:none!important}
  .results{background:#0b1220;border-radius:14px;padding:12px;margin-top:10px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  @media(max-width:540px){.grid{grid-template-columns:1fr}}
  .seg{display:flex;gap:10px;margin:10px 0 14px}
  .seg button{flex:1;border:0;border-radius:12px;padding:12px;font-weight:900;cursor:pointer;background:#0b1220;color:#fff}
  .seg button.active{background:linear-gradient(90deg,#0ea5e9,#2563eb)}

  /* workouts compact */
  .day-card{background:#0b1220;border-radius:14px;padding:12px;margin-bottom:12px}
  .day-head{display:flex;justify-content:space-between;align-items:center;background:#0f172a;border-radius:12px;padding:10px;cursor:pointer}
  .day-name{color:#38bdf8;font-weight:900}
  .exercise{background:#1e293b;border-radius:12px;padding:8px 10px;margin-top:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .exercise input{margin:0;border-radius:10px}
  .exercise-name{flex:1;min-width:180px}
  .counter{display:flex;align-items:center;gap:4px;background:#0f172a;border-radius:10px;padding:4px 6px;white-space:nowrap}
  .counter button{background:#2563eb;border:0;color:#fff;width:28px;height:28px;border-radius:8px;font-weight:900;cursor:pointer}
  .counter span{min-width:92px;text-align:center;font-weight:900}
  .delbtn{background:#ef4444;border:0;color:#fff;width:34px;height:34px;border-radius:10px;font-weight:900;cursor:pointer}

  /* weight rows */
  .wrow{background:#1e293b;border-radius:12px;padding:10px;margin-top:10px;display:flex;gap:10px;align-items:center}
  .wtag{background:#0f172a;border-radius:10px;padding:8px 10px;font-weight:900;min-width:92px;text-align:center}
  .wrow input{margin:0}
</style>
</head>

<body>
<h1>WS Fitness</h1>

<div class="pill">
  <div>
    Session: <b id="sessName">—</b>
    <span class="badge" id="sessRole">—</span>
    <span class="badge" id="managedBadge" style="display:none;"></span>
  </div>
  <button class="mini" style="max-width:170px;margin:0" onclick="logout()">Logout</button>
</div>

<div class="tabs" id="tabs" style="display:none;">
  <button class="tab active" id="tProfile" onclick="go('profile')">Profile</button>
  <button class="tab hidden" id="tAdmin" onclick="go('admin')">Admin</button>
  <button class="tab hidden" id="tCoachPanel" onclick="go('coachpanel')">Coach</button>
  <button class="tab" id="tCalc" onclick="go('calc')">Calculator</button>
  <button class="tab" id="tWork" onclick="go('work')">Workouts</button>
  <button class="tab" id="tWeek" onclick="go('week')">Weekly</button>
  <button class="tab" id="tWeight" onclick="go('weight')">Weight</button>
</div>

<!-- LOGIN -->
<div class="page active" id="pLogin">
  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Login</div>
  </div>

  <div class="seg">
    <button id="segLogin" class="active" onclick="switchAuth('login')">Login</button>
    <button id="segCreateCoach" onclick="switchAuth('coach')">Create Coach</button>
  </div>

  <div id="authLogin">
    <label>Name</label>
    <input id="loginName" placeholder="name" autocapitalize="none" autocomplete="username"/>

    <label>PIN (6 digits)</label>
    <input id="loginPin" type="password" inputmode="numeric" maxlength="6" placeholder="******" autocomplete="current-password"/>

    <button class="primary" onclick="login()">Login</button>
    <div class="small danger" id="loginMsg"></div>
  </div>

  <div id="authCoach" class="hidden">
    <div class="box">
      <div style="font-weight:900;color:#38bdf8">Create Coach</div>
    </div>

    <label>Name</label>
    <input id="coachName" placeholder="name" autocapitalize="none"/>

    <label>PIN (6 digits)</label>
    <input id="coachPin" type="password" inputmode="numeric" maxlength="6" placeholder="******" />

    <button class="primary" onclick="createCoach()">Create Coach</button>
    <div class="small danger" id="coachMsg"></div>
  </div>
</div>

<!-- PROFILE -->
<div class="page" id="pProfile">
  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Profile</div>

    <div id="managedBox" class="hidden">
      <label>Managed Profile</label>
      <select id="managedSel"></select>
      <button class="mini" onclick="setManaged()">Set Managed</button>
      <div class="small ok" id="managedMsg"></div>
    </div>

    <label>Change PIN (6 digits)</label>
    <input id="myNewPin" type="password" inputmode="numeric" maxlength="6" placeholder="******" />
    <button class="mini" onclick="changeMyPin()">Change PIN</button>
    <div class="small danger" id="myPinMsg"></div>
  </div>
</div>

<!-- ADMIN PANEL -->
<div class="page" id="pAdmin">
  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Admin Panel</div>
  </div>

  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Change Admin PIN</div>
    <label>New PIN</label>
    <input id="adminNewPin" type="password" inputmode="numeric" maxlength="6" placeholder="******" />
    <button class="mini" onclick="changeAdminPin()">Change</button>
    <div class="small danger" id="adminPinMsg"></div>
  </div>

  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Create Coach</div>
    <label>Name</label>
    <input id="aCoachName" placeholder="name" autocapitalize="none"/>
    <label>PIN</label>
    <input id="aCoachPin" type="password" inputmode="numeric" maxlength="6" placeholder="******" />
    <button class="mini" onclick="adminCreateCoach()">Create</button>
    <div class="small danger" id="aCoachMsg"></div>
  </div>

  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Manage Coaches</div>
    <label>Select Coach</label>
    <select id="aCoachSel"></select>

    <label>Reset Coach PIN</label>
    <input id="aCoachResetPin" type="password" inputmode="numeric" maxlength="6" placeholder="******" />
    <button class="mini" onclick="adminResetCoachPin()">Reset</button>

    <button class="mini red" onclick="adminDeleteCoach(false)">Delete Coach (0 subs only)</button>
    <button class="mini red" onclick="adminDeleteCoach(true)">Delete Coach + Subs</button>
    <div class="small danger" id="aCoachOpsMsg"></div>
  </div>

  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Reset All Data</div>
    <button class="mini red" onclick="resetAll()">Reset All Data (wipe)</button>
    <div class="small danger">يمسح كل الحسابات والبيانات من الجهاز.</div>
  </div>
</div>

<!-- COACH PANEL -->
<div class="page" id="pCoachPanel">
  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Coach Panel</div>
  </div>

  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Create Subscriber</div>
    <label>Name</label>
    <input id="cSubName" placeholder="name" autocapitalize="none"/>

    <label>PIN (6 digits)</label>
    <input id="cSubPin" type="password" inputmode="numeric" maxlength="6" placeholder="******" />

    <label>Subscription Duration</label>
    <select id="cSubMonths">
      <option value="1">1 month</option><option value="2">2 months</option><option value="3">3 months</option>
      <option value="4">4 months</option><option value="5">5 months</option>
      <option value="6">6 months</option>
    </select>

    <button class="mini" onclick="coachAddSubscriber()">Create Subscriber</button>
    <div class="small danger" id="cSubMsg"></div>
  </div>

  <div class="box">
    <div style="font-weight:900;color:#38bdf8">My Subscribers</div>
    <label>Select Subscriber</label>
    <select id="cMySubsSel"></select>

    <div class="results">
      <div id="subExpInfo">Subscription: --</div>
    </div>

    <label>Reset Subscriber PIN</label>
    <input id="cResetPin" type="password" inputmode="numeric" maxlength="6" placeholder="******" />
    <button class="mini" onclick="coachResetSubPin()">Reset PIN</button>

    <label>Extend Subscription (+ months)</label>
    <select id="cExtendMonths">
      <option value="1">+1 month</option><option value="2">+2 months</option><option value="3">+3 months</option>
      <option value="4">+4 months</option><option value="5">+5 months</option>
      <option value="6">+6 months</option>
    </select>
    <button class="mini" onclick="coachExtendSub()">Extend Subscription</button>

    <button class="mini red" onclick="coachDeleteSub()">Delete Subscriber</button>
    <div class="small danger" id="cSubOpsMsg"></div>
  </div>
</div>

<!-- CALC -->
<div class="page" id="pCalc">
  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Calculator</div>
    <div class="small danger" id="calcSubWarn"></div>
  </div>

  <div id="calcInputsWrap">
    <label>Weight</label><select id="weight"></select>
    <label>Height</label><select id="height"></select>
    <label>Age</label><select id="age"></select>

    <label>Gender</label>
    <select id="gender"><option value="male">Male</option><option value="female">Female</option></select>

    <label>Activity Days</label>
    <select id="activityDays">
      <option value="1">1</option><option value="2">2</option><option value="3">3</option>
      <option value="4">4</option><option value="5">5</option><option value="6">6</option>
    </select>

    <label>Goal</label>
    <select id="goal"><option value="cut">Cut</option><option value="maintain">Maintain</option><option value="bulk">Bulk</option></select>

    <label>Protein Multiplier</label>
    <select id="proteinFactor">
      <option value="1.5">1.5</option><option value="1.8">1.8</option><option value="2">2</option>
      <option value="2.2">2.2</option><option value="2.5">2.5</option><option value="2.8">2.8</option>
      <option value="3">3</option>
    </select>

    <label>Meals</label>
    <select id="meals">
      <option value="2">2</option><option value="3">3</option><option value="4">4</option>
      <option value="5">5</option><option value="6">6</option>
    </select>

    <label>Weekly Goal</label>
    <select id="weeklyGoal">
      <option value="0.5">0.5 kg</option><option value="1">1 kg</option><option value="1.5">1.5 kg</option>
      <option value="2">2 kg</option>
    </select>

    <button class="primary" id="calcBtn">Calculate & Save</button>
  </div>

  <div class="results" id="calcResults">
    <div id="outCalories">Daily Calories: --</div>
    <hr style="border:0;border-top:1px solid #334155;margin:10px 0">
    <div id="outMacros">Protein/Carbs/Fat: --</div>
    <hr style="border:0;border-top:1px solid #334155;margin:10px 0">
    <div id="outPerMeal">Per Meal: --</div>
    <hr style="border:0;border-top:1px solid #334155;margin:10px 0">
    <div id="outBurn">Daily Burn Target: --</div>
  </div>
</div>

<!-- WORKOUTS -->
<div class="page" id="pWork">
  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Workouts</div>
  </div>
  <div id="workContainer"></div>
  <button class="mini red hidden" id="workResetBtn" onclick="resetWorkouts()">Reset workouts</button>
</div>

<!-- WEEKLY -->
<div class="page" id="pWeek">
  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Weekly Burn Tracker</div>
    <div class="small" id="weeklyTargetLabel">Weekly target burn: -- kcal</div>
  </div>

  <label>Today</label>
  <select id="todayIndex">
    <option value="1">Day 1</option><option value="2">Day 2</option><option value="3">Day 3</option>
    <option value="4">Day 4</option><option value="5">Day 5</option><option value="6">Day 6</option><option value="7">Day 7</option>
  </select>

  <div class="grid" id="daysGrid"></div>
  <button class="mini" onclick="recalcWeek()">Update</button>
  <button class="mini red hidden" id="weekResetBtn" onclick="resetWeek()">Reset week</button>

  <div class="results">
    <div id="wkBurned">Burned so far: --</div>
    <div id="wkRemaining">Remaining: --</div>
    <div id="wkPerDay">Required per remaining day: --</div>
    <div id="wkTomorrow">Tomorrow target: --</div>
    <div class="small danger" id="wkWarn"></div>
  </div>
</div>

<!-- WEIGHT -->
<div class="page" id="pWeight">
  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Weight Tracker</div>
  </div>

  <label>Duration (Weeks)</label>
  <select id="weightWeeks"></select>

  <div class="results">
    <div id="wStart">Start: --</div>
    <div id="wCurrent">Current: --</div>
    <div id="wChange">Change: --</div>
    <div id="wAvg">Avg / Week: --</div>
  </div>

  <div id="weightRows"></div>
  <button class="mini red hidden" id="weightResetBtn" onclick="resetWeight()">Reset weight log</button>
</div>

<script>
/* ========= Helpers ========= */
const $ = (id)=>document.getElementById(id);
const PIN_RE = /^[0-9]{6}$/;
const NAME_RE = /^[a-z0-9_]{3,20}$/i;

/* ========= NEW hash (FNV-1a) ========= */
function hashPin(str){
  let h = 0x811c9dc5;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = (h * 0x01000193) >>> 0;
  }
  return ("00000000" + h.toString(16)).slice(-8);
}

/* ========= OLD hash compatibility (SHA-256 pure JS) ========= */
function sha256Hex(ascii) {
  function rightRotate(value, amount) { return (value>>>amount) | (value<<(32-amount)); }
  var mathPow = Math.pow, maxWord = mathPow(2, 32);
  var lengthProperty = 'length', i, j;
  var result = '';

  var words = [];
  var asciiBitLength = ascii[lengthProperty]*8;

  var hash = sha256Hex.h = sha256Hex.h || [];
  var k = sha256Hex.k = sha256Hex.k || [];
  var primeCounter = k[lengthProperty];

  var isComposite = {};
  for (var candidate = 2; primeCounter < 64; candidate++) {
    if (!isComposite[candidate]) {
      for (i = 0; i < 313; i += candidate) isComposite[i] = candidate;
      hash[primeCounter] = (mathPow(candidate, .5)*maxWord)|0;
      k[primeCounter++] = (mathPow(candidate, 1/3)*maxWord)|0;
    }
  }

  ascii += '\x80';
  while (ascii[lengthProperty]%64 - 56) ascii += '\x00';
  for (i = 0; i < ascii[lengthProperty]; i++) {
    j = ascii.charCodeAt(i);
    words[i>>2] |= j << ((3 - i)%4)*8;
  }
  words[words[lengthProperty]] = ((asciiBitLength/maxWord)|0);
  words[words[lengthProperty]] = (asciiBitLength);

  for (j = 0; j < words[lengthProperty];) {
    var w = words.slice(j, j += 16);
    var oldHash = hash.slice(0);

    for (i = 0; i < 64; i++) {
      var w15 = w[i - 15], w2 = w[i - 2];

      var a = hash[0], e = hash[4];
      var temp1 = hash[7]
        + (rightRotate(e, 6) ^ rightRotate(e, 11) ^ rightRotate(e, 25))
        + ((e & hash[5]) ^ ((~e) & hash[6]))
        + k[i]
        + (w[i] = (i < 16) ? w[i] : (
            w[i - 16]
            + (rightRotate(w15, 7) ^ rightRotate(w15, 18) ^ (w15>>>3))
            + w[i - 7]
            + (rightRotate(w2, 17) ^ rightRotate(w2, 19) ^ (w2>>>10))
          )|0
        );

      var temp2 = (rightRotate(a, 2) ^ rightRotate(a, 13) ^ rightRotate(a, 22))
        + ((a & hash[1]) ^ (a & hash[2]) ^ (hash[1] & hash[2]));

      hash = [(temp1 + temp2)|0].concat(hash);
      hash[4] = (hash[4] + temp1)|0;
      hash.pop();
    }

    for (i = 0; i < 8; i++) hash[i] = (hash[i] + oldHash[i])|0;
  }

  for (i = 0; i < 8; i++) {
    for (j = 3; j + 1; j--) {
      var b = (hash[i] >> (j*8)) & 255;
      result += ((b < 16) ? 0 : '') + b.toString(16);
    }
  }
  return result;
}

/* ========= Storage ========= */
function uid(){ return "id_"+Math.random().toString(16).slice(2)+Date.now().toString(16); }
function loadAccounts(){ try{ return JSON.parse(localStorage.getItem("ws_accounts")||"[]"); }catch{ return []; } }
function saveAccounts(a){ localStorage.setItem("ws_accounts", JSON.stringify(a)); }
function findAccById(id){ return loadAccounts().find(x=>x.id===id) || null; }
function findAccByName(u){
  const key=(u||"").trim().toLowerCase();
  return loadAccounts().find(x=>String(x.name||"").toLowerCase()===key) || null;
}
function setSession(obj){ localStorage.setItem("ws_session", JSON.stringify(obj)); }
function getSession(){ try{ return JSON.parse(localStorage.getItem("ws_session")||"null"); }catch{ return null; } }
function clearSession(){ localStorage.removeItem("ws_session"); }
function setManagedId(id){ localStorage.setItem("ws_managed_id", id); }
function getManagedId(){ return localStorage.getItem("ws_managed_id") || ""; }
function pkey(key){ return `ws_p_${getManagedId()||"none"}_${key}`; }
function pget(key){ return localStorage.getItem(pkey(key)); }
function pset(key,val){ localStorage.setItem(pkey(key), val); }
function premove(key){ localStorage.removeItem(pkey(key)); }

function nowMs(){ return Date.now(); }
function addMonthsMs(startMs, months){
  const d = new Date(startMs);
  const day = d.getDate();
  d.setMonth(d.getMonth() + months);
  if(d.getDate() < day) d.setDate(0);
  return d.getTime();
}
function fmtDate(ms){
  if(!ms) return "--";
  const d=new Date(ms);
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const da=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
function isExpiredSubscriber(acc){
  if(!acc || acc.role!=="subscriber") return false;
  const exp = Number(acc.subExpiresAt||0);
  return exp>0 && nowMs() > exp;
}
function subStatusText(acc){
  if(!acc || acc.role!=="subscriber") return "";
  const exp=Number(acc.subExpiresAt||0);
  const status = isExpiredSubscriber(acc) ? "Expired" : "Active";
  return `${status} | Exp: ${fmtDate(exp)}`;
}

function ensureAdmin(){
  const acc=loadAccounts();
  if(!acc.some(a=>a.role==="admin")){
    acc.push({id:"admin_fixed", role:"admin", name:"admin", pinHash: hashPin("123456")});
    saveAccounts(acc);
  }
}

/* ========= Roles ========= */
function me(){ const s=getSession(); return s ? findAccById(s.id) : null; }
function isAdmin(){ const a=me(); return !!a && a.role==="admin"; }
function isCoach(){ const a=me(); return !!a && a.role==="coach"; }
function isSub(){ const a=me(); return !!a && a.role==="subscriber"; }

function canEditEverything(){
  if(isAdmin()) return true;
  if(!isCoach()) return false;
  const a=me();
  const managed=findAccById(getManagedId());
  if(!a || !managed) return false;
  if(managed.id===a.id) return true;
  return managed.role==="subscriber" && managed.coachId===a.id;
}
function canEditMaxWeightOnly(){
  if(!isSub()) return false;
  const a=me();
  return a && getManagedId()===a.id;
}
function canEditMaxWeight(){ return canEditEverything() || canEditMaxWeightOnly(); }

/* ========= UI ========= */
function switchAuth(mode){
  $("segLogin").classList.toggle("active", mode==="login");
  $("segCreateCoach").classList.toggle("active", mode==="coach");
  $("authLogin").classList.toggle("hidden", mode!=="login");
  $("authCoach").classList.toggle("hidden", mode!=="coach");
  $("loginMsg").textContent="";
  $("coachMsg").textContent="";
}
function hydrateHeader(){
  const a=me();
  $("sessName").textContent = a ? a.name : "—";
  $("sessRole").textContent = a ? a.role.toUpperCase() : "—";
  const managed=findAccById(getManagedId());
  if((isAdmin() || isCoach()) && managed && a && managed.id!==a.id){
    $("managedBadge").style.display="inline-block";
    $("managedBadge").textContent=`Managing: ${managed.name}`;
  } else $("managedBadge").style.display="none";
}
function showLogin(){
  $("tabs").style.display="none";
  ["pProfile","pAdmin","pCoachPanel","pCalc","pWork","pWeek","pWeight"].forEach(id=>$(id).classList.remove("active"));
  $("pLogin").classList.add("active");
  hydrateHeader();
  switchAuth("login");
}
function showApp(){
  $("pLogin").classList.remove("active");
  $("tabs").style.display="flex";
  $("tAdmin").classList.toggle("hidden", !isAdmin());
  $("tCoachPanel").classList.toggle("hidden", !(isCoach() || isAdmin()));
  hydrateHeader();
  go("profile");
}
function go(which){
  ["Profile","Admin","CoachPanel","Calc","Work","Week","Weight"].forEach(p=> $("p"+p).classList.remove("active"));
  ["Profile","Admin","CoachPanel","Calc","Work","Week","Weight"].forEach(t=> $("t"+t)?.classList.remove("active"));
  const map={profile:"Profile",admin:"Admin",coachpanel:"CoachPanel",calc:"Calc",work:"Work",week:"Week",weight:"Weight"};
  const P="p"+map[which], T="t"+map[which];
  $(P).classList.add("active");
  $(T).classList.add("active");

  if(which==="profile") renderProfile();
  if(which==="admin") renderAdminPanel();
  if(which==="coachpanel") renderCoachPanel();
  if(which==="calc") { loadCalcInputs(); renderCalcMode(); renderCalcResults(); renderSubscriberCalcView(); }
  if(which==="work") { renderWorkouts(); applyWorkButtons(); }
  if(which==="week") { buildWeekInputs(); loadWeekInputs(); syncWeeklyTarget(); recalcWeek(); applyWeekButtons(); }
  if(which==="weight"){ loadWeightTracker(); applyWeightButtons(); }
  hydrateHeader();
}

/* ========= Pin check (NEW + OLD) ========= */
function verifyPin(pin, storedHash){
  const stored = String(storedHash||"");
  if(stored.length === 8) return hashPin(pin) === stored;     // NEW
  if(stored.length === 64) return sha256Hex(pin) === stored;  // OLD
  return hashPin(pin) === stored; // fallback
}

/* ========= Auth ========= */
function login(){
  $("loginMsg").textContent="";
  const name=($("loginName").value||"").trim().toLowerCase();
  const pin=($("loginPin").value||"").trim();
  if(!name){ $("loginMsg").textContent="اكتب Name."; return; }
  if(!PIN_RE.test(pin)){ $("loginMsg").textContent="PIN لازم 6 أرقام."; return; }

  const a=findAccByName(name);
  if(!a){ $("loginMsg").textContent="الحساب غير موجود."; return; }
  if(!verifyPin(pin, a.pinHash)){ $("loginMsg").textContent="PIN غلط."; return; }

  if(a.role==="subscriber" && isExpiredSubscriber(a)){
    $("loginMsg").textContent="Subscription expired.";
    return;
  }

  setSession({id:a.id});
  $("loginPin").value="";
  setManagedId(a.id);
  showApp();
}
function logout(){
  clearSession();
  localStorage.removeItem("ws_managed_id");
  showLogin();
}
function resetAll(){
  if(!isAdmin()){ alert("Not allowed."); return; }
  if(!confirm("Reset ALL data?")) return;
  localStorage.clear();
  location.reload();
}
function createCoach(){
  $("coachMsg").textContent="";
  const name=($("coachName").value||"").trim().toLowerCase();
  const pin=($("coachPin").value||"").trim();

  if(!NAME_RE.test(name) || name.includes(" ")){ $("coachMsg").textContent="Name غير صالح (3-20: حروف/أرقام/_)."; return; }
  if(findAccByName(name)){ $("coachMsg").textContent="Name مستخدم من قبل."; return; }
  if(!PIN_RE.test(pin)){ $("coachMsg").textContent="PIN لازم 6 أرقام."; return; }

  const acc=loadAccounts();
  acc.push({id:uid(), role:"coach", name, pinHash: hashPin(pin)});
  saveAccounts(acc);

  $("coachName").value=""; $("coachPin").value="";
  $("coachMsg").innerHTML=`<span class="ok">✅ Coach created.</span>`;
  switchAuth("login");
}

/* ========= Profile / Managed ========= */
function renderProfile(){
  const a=me(); if(!a){ showLogin(); return; }
  $("managedMsg").textContent="";
  $("myPinMsg").textContent="";
  const allowManaged = isAdmin() || isCoach();
  $("managedBox").classList.toggle("hidden", !allowManaged);
  if(allowManaged) fillManagedSelect();
  if(isSub()){
    if(getManagedId()!==a.id) setManagedId(a.id);
  }
}
function fillManagedSelect(){
  const sel=$("managedSel"); sel.innerHTML="";
  const acc=loadAccounts().filter(x=>x.role!=="admin");
  let list=[];
  if(isAdmin()) list=acc;
  else if(isCoach()){
    const a=me();
    list=[a, ...acc.filter(x=>x.role==="subscriber" && x.coachId===a.id)];
  }
  list.forEach(x=>{
    const opt=document.createElement("option");
    opt.value=x.id;
    opt.textContent=`${x.name} (${x.role})`;
    sel.appendChild(opt);
  });
  if(getManagedId()) sel.value=getManagedId();
  else if(list[0]) { setManagedId(list[0].id); sel.value=list[0].id; }
}
function setManaged(){
  const id=$("managedSel").value;
  const target=findAccById(id);
  const a=me();
  if(!a || !target) return;

  if(isAdmin()){
    setManagedId(id);
    $("managedMsg").textContent=`✅ Managing: ${target.name}`;
    hydrateHeader();
    return;
  }
  if(isCoach()){
    if(target.id===a.id || (target.role==="subscriber" && target.coachId===a.id)){
      setManagedId(id);
      $("managedMsg").textContent=`✅ Managing: ${target.name}`;
      hydrateHeader();
    } else $("managedMsg").textContent="Not allowed.";
  }
}
function changeMyPin(){
  $("myPinMsg").textContent="";
  const a=me(); if(!a) return;
  const pin=($("myNewPin").value||"").trim();
  if(!PIN_RE.test(pin)){ $("myPinMsg").textContent="PIN لازم 6 أرقام."; return; }

  const acc=loadAccounts();
  const i=acc.findIndex(x=>x.id===a.id);
  acc[i].pinHash = hashPin(pin);
  saveAccounts(acc);

  $("myNewPin").value="";
  $("myPinMsg").innerHTML=`<span class="ok">✅ Updated.</span>`;
}

/* ========= Admin Panel ========= */
function renderAdminPanel(){
  if(!isAdmin()){ go("profile"); return; }
  $("adminPinMsg").textContent="";
  $("aCoachMsg").textContent="";
  $("aCoachOpsMsg").textContent="";
  refreshAdminCoachList();
}
function refreshAdminCoachList(){
  const acc=loadAccounts();
  const coaches=acc.filter(x=>x.role==="coach");
  const sel=$("aCoachSel");
  sel.innerHTML="";
  if(!coaches.length){
    const o=document.createElement("option"); o.value=""; o.textContent="No coaches";
    sel.appendChild(o);
  } else {
    coaches.forEach(c=>{
      const o=document.createElement("option");
      o.value=c.id; o.textContent=c.name;
      sel.appendChild(o);
    });
  }
}
function changeAdminPin(){
  $("adminPinMsg").textContent="";
  const pin=($("adminNewPin").value||"").trim();
  if(!PIN_RE.test(pin)){ $("adminPinMsg").textContent="PIN لازم 6 أرقام."; return; }
  const acc=loadAccounts();
  const i=acc.findIndex(x=>x.role==="admin");
  acc[i].pinHash = hashPin(pin);
  saveAccounts(acc);
  $("adminNewPin").value="";
  $("adminPinMsg").innerHTML=`<span class="ok">✅ Updated.</span>`;
}
function adminCreateCoach(){
  $("aCoachMsg").textContent="";
  const name=($("aCoachName").value||"").trim().toLowerCase();
  const pin=($("aCoachPin").value||"").trim();
  if(!NAME_RE.test(name) || name.includes(" ")){ $("aCoachMsg").textContent="Name غير صالح."; return; }
  if(findAccByName(name)){ $("aCoachMsg").textContent="Name مستخدم."; return; }
  if(!PIN_RE.test(pin)){ $("aCoachMsg").textContent="PIN لازم 6 أرقام."; return; }
  const acc=loadAccounts();
  acc.push({id:uid(), role:"coach", name, pinHash: hashPin(pin)});
  saveAccounts(acc);
  $("aCoachName").value=""; $("aCoachPin").value="";
  $("aCoachMsg").innerHTML=`<span class="ok">✅ Coach created.</span>`;
  refreshAdminCoachList();
  fillManagedSelect();
}
function adminResetCoachPin(){
  $("aCoachOpsMsg").textContent="";
  const id=$("aCoachSel").value;
  const pin=($("aCoachResetPin").value||"").trim();
  if(!id){ $("aCoachOpsMsg").textContent="اختر مدرب."; return; }
  if(!PIN_RE.test(pin)){ $("aCoachOpsMsg").textContent="PIN لازم 6 أرقام."; return; }
  const acc=loadAccounts();
  const i=acc.findIndex(x=>x.id===id && x.role==="coach");
  if(i<0){ $("aCoachOpsMsg").textContent="غير موجود."; return; }
  acc[i].pinHash = hashPin(pin);
  saveAccounts(acc);
  $("aCoachResetPin").value="";
  $("aCoachOpsMsg").innerHTML=`<span class="ok">✅ Reset.</span>`;
}
function adminDeleteCoach(cascade){
  $("aCoachOpsMsg").textContent="";
  const id=$("aCoachSel").value;
  if(!id){ $("aCoachOpsMsg").textContent="اختر مدرب."; return; }
  const acc=loadAccounts();
  const coach=acc.find(x=>x.id===id && x.role==="coach");
  if(!coach){ $("aCoachOpsMsg").textContent="غير موجود."; return; }
  const subs=acc.filter(x=>x.role==="subscriber" && x.coachId===id);
  if(!cascade && subs.length>0){
    $("aCoachOpsMsg").textContent=`لا يمكن حذف المدرب لأن لديه ${subs.length} مشتركين.`;
    return;
  }
  if(!confirm(`Delete coach: ${coach.name}? ${cascade?"AND subs":""}`)) return;
  let next=acc.filter(x=>x.id!==id);
  if(cascade) next=next.filter(x=>!(x.role==="subscriber" && x.coachId===id));
  saveAccounts(next);
  $("aCoachOpsMsg").innerHTML=`<span class="ok">✅ Deleted.</span>`;
  refreshAdminCoachList();
  fillManagedSelect();
}

/* ========= Coach Panel ========= */
function renderCoachPanel(){
  if(!(isCoach() || isAdmin())) { go("profile"); return; }
  $("cSubMsg").textContent="";
  $("cSubOpsMsg").textContent="";
  fillCoachSubsList();
  updateSubExpInfo();
  $("cMySubsSel").onchange=()=>updateSubExpInfo();
}
function fillCoachSubsList(){
  const sel=$("cMySubsSel"); sel.innerHTML="";
  const acc=loadAccounts();
  let subs=[];
  if(isAdmin()) subs=acc.filter(x=>x.role==="subscriber");
  else {
    const a=me();
    subs=acc.filter(x=>x.role==="subscriber" && x.coachId===a.id);
  }
  if(!subs.length){
    const o=document.createElement("option"); o.value=""; o.textContent="No subscribers";
    sel.appendChild(o);
    return;
  }
  subs.forEach(s=>{
    const o=document.createElement("option");
    o.value=s.id;
    o.textContent = `${s.name} (${subStatusText(s)})`;
    sel.appendChild(o);
  });
}
function updateSubExpInfo(){
  const subId=$("cMySubsSel").value;
  const sub=findAccById(subId);
  if(!sub){ $("subExpInfo").textContent="Subscription: --"; return; }
  $("subExpInfo").textContent = `Subscription: ${subStatusText(sub)}`;
}
function coachAddSubscriber(){
  $("cSubMsg").textContent="";
  const creator=me();
  if(!(isCoach() || isAdmin())){ $("cSubMsg").textContent="Not allowed."; return; }
  const name=($("cSubName").value||"").trim().toLowerCase();
  const pin=($("cSubPin").value||"").trim();
  const months=parseInt($("cSubMonths").value,10);

  if(!NAME_RE.test(name) || name.includes(" ")){ $("cSubMsg").textContent="Name غير صالح."; return; }
  if(findAccByName(name)){ $("cSubMsg").textContent="Name مستخدم."; return; }
  if(!PIN_RE.test(pin)){ $("cSubMsg").textContent="PIN لازم 6 أرقام."; return; }
  if(!(months>=1 && months<=6)){ $("cSubMsg").textContent="مدة الاشتراك 1-6 أشهر."; return; }

  const acc=loadAccounts();
  const coachId = creator.id;
  const start=nowMs();
  const exp=addMonthsMs(start, months);

  acc.push({id:uid(), role:"subscriber", name, coachId, pinHash: hashPin(pin), subStartAt:start, subExpiresAt:exp});
  saveAccounts(acc);

  $("cSubName").value=""; $("cSubPin").value="";
  $("cSubMsg").innerHTML=`<span class="ok">✅ Subscriber created.</span>`;
  fillCoachSubsList();
  updateSubExpInfo();
  if(isAdmin() || isCoach()) fillManagedSelect();
}
function coachResetSubPin(){
  $("cSubOpsMsg").textContent="";
  const subId=$("cMySubsSel").value;
  const pin=($("cResetPin").value||"").trim();
  if(!subId){ $("cSubOpsMsg").textContent="اختر مشترك."; return; }
  if(!PIN_RE.test(pin)){ $("cSubOpsMsg").textContent="PIN لازم 6 أرقام."; return; }
  const sub=findAccById(subId);
  if(!sub || sub.role!=="subscriber"){ $("cSubOpsMsg").textContent="غير موجود."; return; }
  if(isCoach()){
    const a=me();
    if(sub.coachId!==a.id){ $("cSubOpsMsg").textContent="Not allowed."; return; }
  }
  const acc=loadAccounts();
  const i=acc.findIndex(x=>x.id===subId);
  acc[i].pinHash = hashPin(pin);
  saveAccounts(acc);
  $("cResetPin").value="";
  $("cSubOpsMsg").innerHTML=`<span class="ok">✅ Reset.</span>`;
}
function coachExtendSub(){
  $("cSubOpsMsg").textContent="";
  const subId=$("cMySubsSel").value;
  const months=parseInt($("cExtendMonths").value,10);
  if(!subId){ $("cSubOpsMsg").textContent="اختر مشترك."; return; }
  if(!(months>=1 && months<=6)){ $("cSubOpsMsg").textContent="1-6 months."; return; }

  const sub=findAccById(subId);
  if(!sub || sub.role!=="subscriber"){ $("cSubOpsMsg").textContent="غير موجود."; return; }
  if(isCoach()){
    const a=me();
    if(sub.coachId!==a.id){ $("cSubOpsMsg").textContent="Not allowed."; return; }
  }

  const acc=loadAccounts();
  const i=acc.findIndex(x=>x.id===subId);
  const curExp = Number(acc[i].subExpiresAt||0);
  const base = curExp>nowMs() ? curExp : nowMs();
  acc[i].subExpiresAt = addMonthsMs(base, months);
  if(!acc[i].subStartAt) acc[i].subStartAt = nowMs();
  saveAccounts(acc);

  $("cSubOpsMsg").innerHTML=`<span class="ok">✅ Extended.</span>`;
  fillCoachSubsList();
  updateSubExpInfo();
}
function coachDeleteSub(){
  $("cSubOpsMsg").textContent="";
  const subId=$("cMySubsSel").value;
  if(!subId){ $("cSubOpsMsg").textContent="اختر مشترك."; return; }
  const sub=findAccById(subId);
  if(!sub || sub.role!=="subscriber"){ $("cSubOpsMsg").textContent="غير موجود."; return; }
  if(isCoach()){
    const a=me();
    if(sub.coachId!==a.id){ $("cSubOpsMsg").textContent="Not allowed."; return; }
  }
  if(!confirm(`Delete subscriber: ${sub.name}?`)) return;
  saveAccounts(loadAccounts().filter(x=>x.id!==subId));
  if(getManagedId()===subId){
    const a=me();
    setManagedId(a ? a.id : "");
  }
  $("cSubOpsMsg").innerHTML=`<span class="ok">✅ Deleted.</span>`;
  fillCoachSubsList();
  updateSubExpInfo();
  if(isAdmin() || isCoach()) fillManagedSelect();
  hydrateHeader();
}

/* ========= Calculator ========= */
function initCalcDropdowns(){
  $("weight").innerHTML=""; $("height").innerHTML=""; $("age").innerHTML="";
  for(let i=30;i<=200;i++){
    const o=document.createElement("option"); o.value=i; o.textContent=`${i} kg`;
    if(i===80) o.selected=true; $("weight").appendChild(o);
  }
  for(let i=130;i<=210;i++){
    const o=document.createElement("option"); o.value=i; o.textContent=`${i} cm`;
    if(i===170) o.selected=true; $("height").appendChild(o);
  }
  for(let i=14;i<=80;i++){
    const o=document.createElement("option"); o.value=i; o.textContent=`${i} years`;
    if(i===30) o.selected=true; $("age").appendChild(o);
  }
}
function saveCalcInputs(){
  const data={
    weight:$("weight").value, height:$("height").value, age:$("age").value,
    gender:$("gender").value, activityDays:$("activityDays").value,
    goal:$("goal").value, proteinFactor:$("proteinFactor").value,
    meals:$("meals").value, weeklyGoal:$("weeklyGoal").value
  };
  pset("calc_inputs", JSON.stringify(data));
}
function loadCalcInputs(){
  const raw=pget("calc_inputs");
  if(!raw) return;
  try{
    const d=JSON.parse(raw);
    Object.keys(d).forEach(k=>{ if($(k)) $(k).value=d[k]; });
  }catch{}
}
function storeCalcResults(obj){
  pset("calc_results", JSON.stringify(obj));
  pset("weekly_target", String(obj.weeklyTarget));
}
function loadCalcResults(){
  const raw=pget("calc_results");
  if(!raw) return null;
  try{return JSON.parse(raw);}catch{return null;}
}
function renderCalcMode(){
  if(isSub()){
    $("calcInputsWrap").classList.add("hidden");
  } else {
    $("calcInputsWrap").classList.remove("hidden");
    const fields=["weight","height","age","gender","activityDays","goal","proteinFactor","meals","weeklyGoal"];
    fields.forEach(id=>{ $(id).disabled = !canEditEverything(); $(id).style.opacity = $(id).disabled ? .75 : 1; });
    $("calcBtn").disabled = !canEditEverything();
    $("calcBtn").style.opacity = $("calcBtn").disabled ? .75 : 1;
  }
}
function renderCalcResults(){
  const r=loadCalcResults();
  if(!r){
    $("outCalories").textContent="Daily Calories: --";
    $("outMacros").textContent="Protein/Carbs/Fat: --";
    $("outPerMeal").textContent="Per Meal: --";
    $("outBurn").textContent="Daily Burn Target: --";
    return;
  }
  $("outCalories").textContent = `Daily Calories: ${r.calories} kcal`;
  $("outMacros").innerHTML = `Protein: ${r.protein} g<br>Carbs: ${r.carbs} g<br>Fat: ${r.fat} g`;
  $("outPerMeal").innerHTML =
    `Per Meal (${r.meals} meals):<br><br>`+
    `Protein: ${r.proteinMeal} g<br>`+
    `Carbs: ${r.carbsMeal} g<br>`+
    `Fat: ${r.fatMeal} g`;
  $("outBurn").textContent = `Daily Burn Target: ${r.dailyBurn} kcal`;
}
function renderSubscriberCalcView(){
  const r=loadCalcResults();
  if(isSub() && !r) $("calcSubWarn").textContent="لم يتم حفظ نتائجك بعد.";
  else $("calcSubWarn").textContent="";
}
function calcAndSave(){
  if(!canEditEverything()) { renderCalcResults(); renderSubscriberCalcView(); return; }

  const weight=parseFloat($("weight").value);
  const height=parseFloat($("height").value);
  const age=parseFloat($("age").value);
  const gender=$("gender").value;
  const activityDays=parseInt($("activityDays").value,10);
  const goal=$("goal").value;
  const proteinFactor=parseFloat($("proteinFactor").value);
  const meals=parseInt($("meals").value,10);
  const weeklyGoalKg=parseFloat($("weeklyGoal").value);

  const bmr = (gender==="male")
    ? (10*weight + 6.25*height - 5*age + 5)
    : (10*weight + 6.25*height - 5*age - 161);

  let activityMult = 1.2 + (activityDays - 1)*0.1;
  if(activityMult>1.9) activityMult=1.9;

  let calories = bmr * activityMult;
  if(goal==="cut") calories -= 500;
  if(goal==="bulk") calories += 500;

  const protein = weight * proteinFactor;
  const fat = weight * 0.8;
  const carbs = (calories - (protein*4 + fat*9))/4;

  const res={
    calories: Math.round(calories),
    protein: Math.round(protein),
    carbs: Math.round(carbs),
    fat: Math.round(fat),
    meals,
    proteinMeal: Math.round(protein/meals),
    carbsMeal: Math.round(carbs/meals),
    fatMeal: Math.round(fat/meals),
    weeklyTarget: Math.round(weeklyGoalKg * 7700),
    dailyBurn: Math.round((weeklyGoalKg * 7700)/7)
  };

  saveCalcInputs();
  storeCalcResults(res);
  renderCalcResults();
  syncWeeklyTarget();
  renderSubscriberCalcView();
}
$("calcBtn").addEventListener("click", calcAndSave);

/* ========= Weekly ========= */
function buildWeekInputs(){
  const grid=$("daysGrid");
  if(grid.dataset.built==="1") return;
  grid.innerHTML="";
  for(let d=1; d<=7; d++){
    const wrap=document.createElement("div");
    const lbl=document.createElement("label");
    lbl.textContent=`Day ${d} burned (kcal)`;
    lbl.style.marginTop="0";
    const inp=document.createElement("input");
    inp.type="number"; inp.min="0"; inp.step="10"; inp.id=`day_${d}`; inp.placeholder="0";
    inp.addEventListener("input", ()=>{
      pset(`day_${d}`, inp.value||"");
      recalcWeek();
    });
    wrap.appendChild(lbl); wrap.appendChild(inp);
    grid.appendChild(wrap);
  }
  $("todayIndex").addEventListener("change", ()=>{
    pset("today_index", $("todayIndex").value);
    recalcWeek();
  });
  grid.dataset.built="1";
}
function loadWeekInputs(){
  for(let d=1; d<=7; d++){
    const v=pget(`day_${d}`)||"";
    const el=$(`day_${d}`); if(el) el.value=v;
  }
  const ti=pget("today_index"); if(ti) $("todayIndex").value=ti;
}
function getWeeklyTarget(){
  const v=pget("weekly_target");
  const n=parseFloat(v||"0");
  return isFinite(n)?n:0;
}
function syncWeeklyTarget(){
  const t=getWeeklyTarget();
  $("weeklyTargetLabel").textContent = `Weekly target burn: ${t>0?Math.round(t):"--"} kcal`;
}
function recalcWeek(){
  const target=getWeeklyTarget();
  if(target<=0){
    $("wkWarn").textContent="--";
    $("wkBurned").textContent="Burned so far: --";
    $("wkRemaining").textContent="Remaining: --";
    $("wkPerDay").textContent="Required per remaining day: --";
    $("wkTomorrow").textContent="Tomorrow target: --";
    return;
  } else $("wkWarn").textContent="";

  let burned=0;
  for(let d=1; d<=7; d++){
    const val=parseFloat(($(`day_${d}`).value||"").trim());
    if(isFinite(val) && val>0) burned += val;
  }
  const remaining=Math.max(0, target-burned);
  const today=parseInt($("todayIndex").value,10);
  const remDays=Math.max(0, 7-today);
  const perDay = remDays>0 ? (remaining/remDays) : remaining;

  $("wkBurned").textContent=`Burned so far: ${Math.round(burned)} kcal`;
  $("wkRemaining").textContent=`Remaining: ${Math.round(remaining)} kcal`;
  $("wkPerDay").textContent = remDays>0
    ? `Required per day (${remDays}): ${Math.round(perDay)} kcal/day`
    : `Week finished. Remaining: ${Math.round(remaining)} kcal`;
  $("wkTomorrow").textContent = `Tomorrow target: ${remDays>0?Math.round(perDay):0} kcal`;
}
function applyWeekButtons(){ $("weekResetBtn").classList.toggle("hidden", !canEditEverything()); }
function resetWeek(){
  if(!canEditEverything()) return;
  if(!confirm("Reset week logs?")) return;
  for(let d=1; d<=7; d++){ premove(`day_${d}`); $(`day_${d}`).value=""; }
  premove("today_index"); $("todayIndex").value="1";
  recalcWeek();
}

/* ========= Workouts ========= */
const weekDays = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
function defaultWorkouts(){ const o={}; weekDays.forEach(d=>o[d]=[]); return o; }
function loadWorkouts(){
  const raw=pget("workouts");
  if(!raw) return defaultWorkouts();
  try{
    const d=JSON.parse(raw);
    weekDays.forEach(day=>{ if(!Array.isArray(d[day])) d[day]=[]; });
    return d;
  }catch{return defaultWorkouts();}
}
function saveWorkouts(d){ pset("workouts", JSON.stringify(d)); }
function toggleDay(day){
  const key="open_"+day;
  const open = (pget(key)==="1") ? "0" : "1";
  pset(key, open);
  renderWorkouts();
}
function addExercise(day){
  if(!canEditEverything()) return;
  const d=loadWorkouts();
  d[day].push({name:"", sets:3, maxWeight:0});
  saveWorkouts(d); renderWorkouts();
}
function delExercise(day, idx){
  if(!canEditEverything()) return;
  const d=loadWorkouts();
  d[day].splice(idx,1);
  saveWorkouts(d); renderWorkouts();
}
function updateEx(day, idx, key, val){
  const d=loadWorkouts();
  if(!d[day] || !d[day][idx]) return;

  if(canEditEverything()){
    d[day][idx][key]=val;
    saveWorkouts(d);
    return;
  }
  if(canEditMaxWeightOnly() && key==="maxWeight"){
    d[day][idx].maxWeight=val;
    saveWorkouts(d);
  }
}
function renderWorkouts(){
  const wrap=$("workContainer");
  wrap.innerHTML="";
  const d=loadWorkouts();

  weekDays.forEach(day=>{
    const card=document.createElement("div"); card.className="day-card";
    const head=document.createElement("div"); head.className="day-head"; head.onclick=()=>toggleDay(day);
    const nm=document.createElement("div"); nm.className="day-name"; nm.textContent=day;
    const chev=document.createElement("div"); chev.textContent = (pget("open_"+day)==="1") ? "▲" : "▼";
    head.appendChild(nm); head.appendChild(chev);
    card.appendChild(head);

    const open = (pget("open_"+day)==="1");
    if(open){
      if(canEditEverything()){
        const btn=document.createElement("button");
        btn.className="mini"; btn.textContent="+ Add Exercise";
        btn.onclick=(e)=>{ e.stopPropagation(); addExercise(day); };
        card.appendChild(btn);
      }
      (d[day]||[]).forEach((ex, idx)=>{
        const row=document.createElement("div"); row.className="exercise";

        const name=document.createElement("input");
        name.className="exercise-name";
        name.placeholder="Exercise";
        name.value=ex.name||"";
        name.oninput=(e)=>updateEx(day, idx, "name", e.target.value);
        name.disabled = !canEditEverything();
        name.style.opacity = name.disabled ? .75 : 1;

        const sets=document.createElement("div"); sets.className="counter";
        const sm=document.createElement("button"); sm.textContent="-";
        sm.onclick=()=>{ const cur=parseInt(ex.sets||3,10); if(cur>1){ updateEx(day,idx,"sets",cur-1); renderWorkouts(); } };
        sm.disabled=!canEditEverything(); sm.style.opacity=sm.disabled?.75:1;
        const sv=document.createElement("span"); sv.textContent=`Sets: ${parseInt(ex.sets||3,10)}`;
        const sp=document.createElement("button"); sp.textContent="+";
        sp.onclick=()=>{ const cur=parseInt(ex.sets||3,10); updateEx(day,idx,"sets",cur+1); renderWorkouts(); };
        sp.disabled=!canEditEverything(); sp.style.opacity=sp.disabled?.75:1;
        sets.appendChild(sm); sets.appendChild(sv); sets.appendChild(sp);

        const wt=document.createElement("div"); wt.className="counter";
        const wm=document.createElement("button"); wm.textContent="-";
        wm.onclick=()=>{ let w=parseFloat(ex.maxWeight||0); if(!isFinite(w)) w=0; w=Math.max(0,w-2.5); updateEx(day,idx,"maxWeight",w); renderWorkouts(); };
        wm.disabled=!canEditMaxWeight(); wm.style.opacity=wm.disabled?.75:1;
        const wv=document.createElement("span"); wv.textContent=`Max: ${(parseFloat(ex.maxWeight||0)||0)} kg`;
        const wp=document.createElement("button"); wp.textContent="+";
        wp.onclick=()=>{ let w=parseFloat(ex.maxWeight||0); if(!isFinite(w)) w=0; w=w+2.5; updateEx(day,idx,"maxWeight",w); renderWorkouts(); };
        wp.disabled=!canEditMaxWeight(); wp.style.opacity=wp.disabled?.75:1;
        wt.appendChild(wm); wt.appendChild(wv); wt.appendChild(wp);

        row.appendChild(name); row.appendChild(sets); row.appendChild(wt);

        if(canEditEverything()){
          const del=document.createElement("button");
          del.className="delbtn";
          del.textContent="X";
          del.onclick=()=>delExercise(day, idx);
          row.appendChild(del);
        }
        card.appendChild(row);
      });
    }
    wrap.appendChild(card);
  });
}
function applyWorkButtons(){ $("workResetBtn").classList.toggle("hidden", !canEditEverything()); }
function resetWorkouts(){
  if(!canEditEverything()) return;
  if(!confirm("Reset workouts?")) return;
  premove("workouts");
  weekDays.forEach(d=>premove("open_"+d));
  renderWorkouts();
}

/* ========= Weight Tracker ========= */
function initWeightWeeks(){
  const sel=$("weightWeeks");
  sel.innerHTML="";
  for(let w=4; w<=52; w++){
    const o=document.createElement("option"); o.value=String(w); o.textContent=`${w} weeks`;
    if(w===12) o.selected=true;
    sel.appendChild(o);
  }
  sel.addEventListener("change", ()=>{
    pset("weight_weeks", sel.value);
    renderWeightRows();
    calcWeightSummary();
  });
}
function getWeightWeeks(){
  const saved=pget("weight_weeks");
  const n=parseInt(saved || $("weightWeeks").value || "12",10);
  return Math.max(4, Math.min(52, isFinite(n)?n:12));
}
function loadWeightTracker(){
  const saved=pget("weight_weeks");
  if(saved) $("weightWeeks").value=saved;
  renderWeightRows();
  calcWeightSummary();
}
function renderWeightRows(){
  const weeks=getWeightWeeks();
  const wrap=$("weightRows");
  wrap.innerHTML="";
  for(let i=1;i<=weeks;i++){
    const row=document.createElement("div"); row.className="wrow";
    const tag=document.createElement("div"); tag.className="wtag"; tag.textContent=`Week ${i}`;
    const inp=document.createElement("input");
    inp.type="number"; inp.min="0"; inp.step="0.1"; inp.placeholder="Weight (kg)";
    inp.value = pget("w_"+i) || "";
    inp.addEventListener("input", ()=>{
      pset("w_"+i, inp.value||"");
      calcWeightSummary();
    });
    row.appendChild(tag); row.appendChild(inp);
    wrap.appendChild(row);
  }
}
function calcWeightSummary(){
  const weeks=getWeightWeeks();
  let start=null, last=null, lastIdx=null;
  for(let i=1;i<=weeks;i++){
    const v=parseFloat((pget("w_"+i)||"").trim());
    if(isFinite(v) && v>0){
      if(start===null) start=v;
      last=v; lastIdx=i;
    }
  }
  if(start===null || last===null){
    $("wStart").textContent="Start: --";
    $("wCurrent").textContent="Current: --";
    $("wChange").textContent="Change: --";
    $("wAvg").textContent="Avg / Week: --";
    return;
  }
  const change=last-start;
  const weeksPassed=Math.max(1, (lastIdx-1));
  const avg=change/weeksPassed;

  $("wStart").textContent=`Start: ${start.toFixed(1)} kg`;
  $("wCurrent").textContent=`Current: ${last.toFixed(1)} kg (Week ${lastIdx})`;
  $("wChange").textContent=`Change: ${change.toFixed(1)} kg`;
  $("wAvg").textContent=`Avg / Week: ${avg.toFixed(2)} kg/week`;
}
function applyWeightButtons(){ $("weightResetBtn").classList.toggle("hidden", !canEditEverything()); }
function resetWeight(){
  if(!canEditEverything()) return;
  if(!confirm("Reset weight log?")) return;
  const weeks=getWeightWeeks();
  for(let i=1;i<=weeks;i++) premove("w_"+i);
  renderWeightRows();
  calcWeightSummary();
}

/* ========= Init ========= */
(function init(){
  ensureAdmin();
  initCalcDropdowns();
  initWeightWeeks();
  hydrateHeader();

  const a=me();
  if(a){
    if(a.role==="subscriber" && isExpiredSubscriber(a)){
      clearSession();
      localStorage.removeItem("ws_managed_id");
      showLogin();
      $("loginMsg").textContent="Subscription expired.";
      return;
    }
    setManagedId(a.id);
    showApp();
  } else showLogin();
})();
</script>
</body>
</html>
