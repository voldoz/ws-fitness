<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>WS Fitness</title>

<style>
  body{background:linear-gradient(135deg,#0f172a,#1e293b);color:#fff;font-family:Arial,sans-serif;padding:20px;margin:0;}
  h1{text-align:center;color:#38bdf8;margin:0 0 14px 0;}

  .tabs{display:flex;gap:10px;margin:12px 0 18px 0;flex-wrap:wrap;}
  .tab-btn{flex:1;min-width:110px;padding:12px;border:none;border-radius:12px;cursor:pointer;font-weight:bold;color:#fff;background:#1e293b;transition:.2s;}
  .tab-btn.active{background:linear-gradient(90deg,#0ea5e9,#2563eb);}

  .box{background:#1e293b;padding:14px;border-radius:12px;margin-bottom:12px;line-height:1.7;}
  .small-note{opacity:.9;font-size:13px;margin-top:8px;}
  .danger{color:#fecaca;}
  .muted{opacity:.85;}

  label{display:block;margin-top:14px;font-weight:bold;}
  select, input{
    width:100%;padding:12px;margin-top:6px;border:none;border-radius:12px;background:#1e293b;color:#fff;font-size:15px;outline:none;
  }
  select::-webkit-scrollbar{width:7px;}
  select::-webkit-scrollbar-track{background:#0b1220;border-radius:10px;}
  select::-webkit-scrollbar-thumb{background:#2563eb;border-radius:10px;}

  button.primary{
    margin-top:18px;width:100%;padding:16px;border:none;border-radius:14px;background:linear-gradient(90deg,#0ea5e9,#2563eb);
    color:#fff;font-size:18px;font-weight:bold;cursor:pointer;transition:.2s;
  }
  button.primary:active{transform:scale(.99);}
  .mini-btn{margin-top:12px;width:100%;padding:12px;border:none;border-radius:12px;background:#0f172a;color:#fff;font-weight:bold;cursor:pointer;}
  .mini-btn:hover{filter:brightness(1.08);}
  .red-btn{background:#ef4444 !important;}
  .row{display:flex;gap:10px;flex-wrap:wrap;}
  .row > *{flex:1;min-width:160px;}

  .page{display:none;}
  .page.active{display:block;}

  .pill{
    background:#0b1220;border-radius:14px;padding:10px 12px;margin-bottom:12px;
    display:flex;align-items:center;justify-content:space-between;gap:10px;
  }
  .pill b{color:#38bdf8;}
  .badge{background:#0b1220;border:1px solid #334155;border-radius:999px;padding:6px 10px;font-size:12px;}

  .results{margin-top:18px;background:#0f172a;padding:16px;border-radius:16px;display:none;}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
  @media (max-width:520px){.grid{grid-template-columns:1fr;}}

  /* Workouts accordion */
  .day-card{background:#0f172a;border-radius:16px;padding:12px;margin-bottom:12px;}
  .day-header{display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:pointer;padding:10px;border-radius:12px;background:#0b1220;}
  .day-header:hover{filter:brightness(1.07);}
  .day-name{color:#38bdf8;font-weight:bold;}
  .chev{opacity:.9;font-weight:bold;}
  .day-content{display:none;margin-top:10px;}
  .day-content.open{display:block;}
  .row-actions{margin-top:10px;display:flex;gap:10px;}
  .row-actions button{flex:1;}
  .add-btn{border:none;background:linear-gradient(90deg,#0ea5e9,#2563eb);color:#fff;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:bold;}

  /* Compact workout row */
  .exercise{
    background:#1e293b;border-radius:12px;padding:8px 10px;margin-top:8px;
    display:flex;align-items:center;gap:8px;font-size:14px;
  }
  .exercise-name{
    flex:1;background:#0f172a;border:none;border-radius:8px;padding:8px;color:#fff;font-size:14px;margin:0;
  }
  .counter{
    display:flex;align-items:center;gap:4px;background:#0f172a;border-radius:8px;padding:4px 6px;white-space:nowrap;
  }
  .counter button{
    background:#2563eb;border:none;color:#fff;width:24px;height:24px;border-radius:6px;
    font-weight:bold;cursor:pointer;font-size:14px;line-height:24px;padding:0;
  }
  .counter span{min-width:52px;text-align:center;font-weight:bold;}
  .del-btn{
    background:#ef4444;border:none;color:#fff;width:28px;height:28px;border-radius:8px;
    cursor:pointer;font-weight:bold;line-height:28px;padding:0;
  }
  @media (max-width:420px){
    .exercise{flex-wrap:wrap;}
    .exercise-name{flex:1 1 100%;}
  }

  /* Weight tracker rows */
  .wrow{
    background:#1e293b;border-radius:12px;padding:10px;margin-top:10px;
    display:flex;align-items:center;gap:10px;
  }
  .wrow input{margin:0;padding:10px;border-radius:10px;background:#0f172a;flex:1;}
  .wtag{background:#0f172a;border-radius:10px;padding:8px 10px;font-weight:bold;min-width:92px;text-align:center;}
</style>
</head>

<body>
<h1>WS Fitness</h1>

<div class="pill">
  <div>
    Session: <b id="sessionName">—</b>
    <span class="badge" id="sessionRole">—</span>
    <span class="badge" id="managedBadge" style="display:none;"></span>
  </div>
  <button class="mini-btn" style="max-width:180px;margin:0;" onclick="logout()">Logout</button>
</div>

<div class="tabs" id="tabsBar" style="display:none;">
  <button class="tab-btn active" id="tabDashboard" onclick="showPage('dashboard')">Dashboard</button>
  <button class="tab-btn" id="tabCalc" onclick="showPage('calc')">Calculator</button>
  <button class="tab-btn" id="tabWork" onclick="showPage('work')">Workouts</button>
  <button class="tab-btn" id="tabWeek" onclick="showPage('week')">Weekly</button>
  <button class="tab-btn" id="tabWeight" onclick="showPage('weight')">Weight</button>
</div>

<!-- LOGIN -->
<div class="page active" id="pageLogin">
  <div class="box">
    <div style="font-weight:bold;color:#38bdf8;">Login</div>
    <div class="small-note">اختر حساب (Coach أو Subscriber) ثم ادخل PIN (6 أرقام).</div>
  </div>

  <label>Select Account</label>
  <select id="loginSelect"></select>

  <label>PIN (6 digits)</label>
  <input id="loginPin" type="password" inputmode="numeric" maxlength="6" placeholder="******" />

  <button class="primary" onclick="login()">Login</button>
  <div class="small-note danger" id="loginMsg"></div>

  <div class="box" style="margin-top:14px;">
    <div style="font-weight:bold;color:#38bdf8;">First time?</div>
    <div class="small-note">إذا ما عندك حسابات، اضغط الزر لتكوين حساب مدرب افتراضي.</div>
    <button class="mini-btn" onclick="seedCoach()">Create Default Coach</button>
  </div>
</div>

<!-- DASHBOARD -->
<div class="page" id="pageDashboard">
  <div class="box">
    <div style="font-weight:bold;color:#38bdf8;">Dashboard</div>
    <div class="small-note" id="dashHint"></div>
  </div>

  <!-- COACH PANEL -->
  <div id="coachPanel" style="display:none;">
    <div class="box">
      <div style="font-weight:bold;color:#38bdf8;">Your Subscribers</div>
      <div class="small-note">اختر مشترك للتحكم في بياناته، أو عدّل بياناتك كمدرب.</div>

      <label>Manage (Coach / Subscriber)</label>
      <select id="manageSelect"></select>

      <button class="mini-btn" onclick="setManaged()">Open / Manage</button>
      <button class="mini-btn" onclick="manageSelf()">Manage Coach Profile</button>
    </div>

    <div class="box">
      <div style="font-weight:bold;color:#38bdf8;">Add Subscriber</div>
      <div class="row">
        <div>
          <label>Subscriber Name</label>
          <input id="subName" placeholder="Example: Ahmed" />
        </div>
        <div>
          <label>Subscriber PIN (6 digits)</label>
          <input id="subPin" type="password" inputmode="numeric" maxlength="6" placeholder="******" />
        </div>
      </div>
      <button class="mini-btn" onclick="createSubscriber()">Create Subscriber</button>

      <label>Delete Managed Subscriber</label>
      <button class="mini-btn red-btn" onclick="deleteManagedSubscriber()">Delete (only if managed is subscriber)</button>
      <div class="small-note danger" id="coachMsg"></div>
    </div>
  </div>

  <!-- SUBSCRIBER PANEL -->
  <div id="subscriberPanel" style="display:none;">
    <div class="box">
      <div style="font-weight:bold;color:#38bdf8;">Subscriber Mode</div>
      <div class="small-note">
        ✅ تكتب فقط: Weekly (burned kcal) + Weight (weekly weight)<br>
        ✅ وتقدر تعدّل Max Weight في التمارين فقط.<br>
        ❌ باقي الحقول قراءة فقط.
      </div>
    </div>
  </div>
</div>

<!-- CALC -->
<div class="page" id="pageCalc">
  <label>Weight</label>
  <select id="weight"></select>

  <label>Height</label>
  <select id="height"></select>

  <label>Age</label>
  <select id="age"></select>

  <label>Gender</label>
  <select id="gender">
    <option value="male">Male</option>
    <option value="female">Female</option>
  </select>

  <label>Activity Days</label>
  <select id="activityDays">
    <option value="1">1</option><option value="2">2</option><option value="3">3</option>
    <option value="4">4</option><option value="5">5</option><option value="6">6</option>
  </select>

  <label>Goal</label>
  <select id="goal">
    <option value="cut">Cut</option>
    <option value="maintain">Maintain</option>
    <option value="bulk">Bulk</option>
  </select>

  <label>Protein Multiplier</label>
  <select id="proteinFactor">
    <option value="1.5">1.5</option><option value="1.8">1.8</option><option value="2">2</option>
    <option value="2.2">2.2</option><option value="2.5">2.5</option><option value="2.8">2.8</option>
    <option value="3">3</option>
  </select>

  <label>Meals</label>
  <select id="meals">
    <option value="2">2</option><option value="3">3</option><option value="4">4</option>
    <option value="5">5</option><option value="6">6</option>
  </select>

  <label>Weekly Goal</label>
  <select id="weeklyGoal">
    <option value="0.5">0.5 kg</option><option value="1">1 kg</option><option value="1.5">1.5 kg</option>
    <option value="2">2 kg</option>
  </select>

  <button class="primary" id="calcBtn">Calculate</button>

  <div class="results" id="resultsCalc">
    <div class="box" id="outCalories"></div>
    <div class="box" id="outMacros"></div>
    <div class="box" id="outPerMeal"></div>
    <div class="box" id="outBurn"></div>
    <div class="small-note muted" id="calcModeHint"></div>
  </div>
</div>

<!-- WORKOUT -->
<div class="page" id="pageWork">
  <div class="box">
    <div style="font-weight:bold;color:#38bdf8;">Weekly Workout Plan</div>
    <div class="small-note" id="workHint"></div>
  </div>

  <div id="workoutContainer"></div>
  <button class="mini-btn" id="resetWorkoutsBtn" onclick="resetWorkouts()">Reset workouts (coach only)</button>
</div>

<!-- WEEK -->
<div class="page" id="pageWeek">
  <div class="box">
    <div id="weeklyTargetLabel">Weekly target burn: -- kcal</div>
    <div class="small-note">ادخل كم سعرة حرقتها كل يوم. التطبيق يحسب الهدف المتبقي وهدف بكرة.</div>
  </div>

  <label>Today</label>
  <select id="todayIndex">
    <option value="1">Day 1</option><option value="2">Day 2</option><option value="3">Day 3</option>
    <option value="4">Day 4</option><option value="5">Day 5</option><option value="6">Day 6</option><option value="7">Day 7</option>
  </select>

  <div class="grid" id="daysGrid"></div>

  <button class="mini-btn" onclick="recalcWeek()">Update</button>
  <button class="mini-btn" id="resetWeekBtn" onclick="resetWeek()">Reset week</button>

  <div class="results" id="resultsWeek" style="display:block;">
    <div class="box" id="wkBurned"></div>
    <div class="box" id="wkRemaining"></div>
    <div class="box" id="wkPerDay"></div>
    <div class="box" id="wkTomorrow"></div>
    <div class="small-note danger" id="wkWarn"></div>
  </div>
</div>

<!-- WEIGHT -->
<div class="page" id="pageWeight">
  <div class="box">
    <div style="font-weight:bold;color:#38bdf8;">Weekly Weight Tracker</div>
    <div class="small-note">سجل وزن كل أسبوع.</div>
  </div>

  <label>مدة المتابعة (Weeks)</label>
  <select id="weightWeeks"></select>

  <div class="results" id="weightSummary" style="display:block;">
    <div class="box" id="wStart">Start: --</div>
    <div class="box" id="wCurrent">Current: --</div>
    <div class="box" id="wChange">Change: --</div>
    <div class="box" id="wAvg">Avg / Week: --</div>
  </div>

  <div id="weightRows"></div>

  <button class="mini-btn" id="resetWeightBtn" onclick="resetWeight()">Reset weight log</button>
</div>

<script>
/* ===================== Crypto helpers (PIN) ===================== */
async function sha256(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,"0")).join("");
}
function pinValid6(pin){ return /^[0-9]{6}$/.test(pin); }

/* ===================== Data model ===================== */
function uid(){ return "id_" + Math.random().toString(16).slice(2) + Date.now().toString(16); }

function getAccounts(){
  const raw = localStorage.getItem("ws_accounts");
  if(!raw) return [];
  try{ const arr = JSON.parse(raw); return Array.isArray(arr) ? arr : []; }catch(e){ return []; }
}
function saveAccounts(list){ localStorage.setItem("ws_accounts", JSON.stringify(list)); }
function findAccount(id){ return getAccounts().find(a => a.id === id) || null; }

function setSession(sess){ localStorage.setItem("ws_session", JSON.stringify(sess)); }
function getSession(){
  const raw = localStorage.getItem("ws_session");
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch(e){ return null; }
}
function clearSession(){ localStorage.removeItem("ws_session"); }

function setManagedId(id){ localStorage.setItem("ws_managed_id", id); }
function getManagedId(){ return localStorage.getItem("ws_managed_id") || ""; }

/* Profile-scoped storage for managed account */
function pkey(key){
  const pid = getManagedId() || "none";
  return `ws_p_${pid}_${key}`;
}
function pget(key){ return localStorage.getItem(pkey(key)); }
function pset(key,val){ localStorage.setItem(pkey(key), val); }
function premove(key){ localStorage.removeItem(pkey(key)); }

/* ===================== UI refs ===================== */
const tabsBar = document.getElementById("tabsBar");
const sessionName = document.getElementById("sessionName");
const sessionRole = document.getElementById("sessionRole");
const managedBadge = document.getElementById("managedBadge");

const loginSelect = document.getElementById("loginSelect");
const loginPin = document.getElementById("loginPin");
const loginMsg = document.getElementById("loginMsg");

const dashHint = document.getElementById("dashHint");
const coachPanel = document.getElementById("coachPanel");
const subscriberPanel = document.getElementById("subscriberPanel");

const manageSelect = document.getElementById("manageSelect");
const subName = document.getElementById("subName");
const subPin = document.getElementById("subPin");
const coachMsg = document.getElementById("coachMsg");

const calcModeHint = document.getElementById("calcModeHint");
const workHint = document.getElementById("workHint");

const resetWorkoutsBtn = document.getElementById("resetWorkoutsBtn");
const resetWeekBtn = document.getElementById("resetWeekBtn");
const resetWeightBtn = document.getElementById("resetWeightBtn");

/* ===================== Pages ===================== */
function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
function showPage(which){
  ["login","dashboard","calc","work","week","weight"].forEach(k=>{
    const el = document.getElementById("page"+cap(k));
    if(el) el.classList.remove("active");
    const tab = document.getElementById("tab"+cap(k));
    if(tab) tab.classList.remove("active");
  });
  document.getElementById("page"+cap(which)).classList.add("active");
  const tab = document.getElementById("tab"+cap(which));
  if(tab) tab.classList.add("active");

  if(which==="dashboard") renderDashboard();
  if(which==="calc") { loadCalcFromProfile(); applyPermissions(); }
  if(which==="work") { renderWorkouts(); applyPermissions(); }
  if(which==="week") { rebuildWeekInputsFromStorage(); syncWeeklyTargetUI(); recalcWeek(); applyPermissions(); }
  if(which==="weight") { loadWeightTracker(); applyPermissions(); }
}

/* ===================== Seed / Login ===================== */
async function seedCoach(){
  const accounts = getAccounts();
  if(accounts.some(a => a.role==="coach")){
    loginMsg.textContent = "يوجد مدرب بالفعل.";
    return;
  }
  const coachId = uid();
  const pin = "123456"; // default 6 digits
  const pinHash = await sha256(pin);
  accounts.push({ id: coachId, name: "Coach", role:"coach", coachId:null, pinHash });
  saveAccounts(accounts);
  loginMsg.innerHTML = `✅ Created Coach (PIN: <b>123456</b>)`;
  renderLoginAccounts();
}

function renderLoginAccounts(){
  const accounts = getAccounts();
  loginSelect.innerHTML = "";

  const coaches = accounts.filter(a=>a.role==="coach");
  const subs = accounts.filter(a=>a.role==="subscriber");

  function addGroup(title, list){
    if(list.length===0) return;
    const og = document.createElement("optgroup");
    og.label = title;
    list.forEach(a=>{
      const opt = document.createElement("option");
      opt.value = a.id;
      opt.textContent = a.name + (a.role==="subscriber" ? ` (Coach: ${findAccount(a.coachId)?.name || "—"})` : "");
      og.appendChild(opt);
    });
    loginSelect.appendChild(og);
  }

  addGroup("Coaches", coaches);
  addGroup("Subscribers", subs);

  if(accounts.length===0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No accounts yet";
    loginSelect.appendChild(opt);
  }
}

async function login(){
  loginMsg.textContent = "";
  const id = loginSelect.value;
  const pin = (loginPin.value || "").trim();

  if(!id){ loginMsg.textContent = "اختر حساب."; return; }
  if(!pinValid6(pin)){ loginMsg.textContent = "PIN لازم يكون 6 أرقام."; return; }

  const acc = findAccount(id);
  if(!acc){ loginMsg.textContent = "الحساب غير موجود."; return; }

  const h = await sha256(pin);
  if(h !== acc.pinHash){
    loginMsg.textContent = "PIN غلط.";
    return;
  }

  setSession({ accountId: acc.id, role: acc.role });
  setManagedId(acc.id); // subscriber manages self; coach starts self
  loginPin.value = "";

  hydrateSessionUI();
  tabsBar.style.display = "flex";
  showPage("dashboard");
}

function logout(){
  clearSession();
  localStorage.removeItem("ws_managed_id");
  tabsBar.style.display = "none";
  sessionName.textContent = "—";
  sessionRole.textContent = "—";
  managedBadge.style.display = "none";
  renderLoginAccounts();
  showPage("login");
}

function hydrateSessionUI(){
  const sess = getSession();
  if(!sess) return;
  const acc = findAccount(sess.accountId);
  if(!acc) return;

  sessionName.textContent = acc.name;
  sessionRole.textContent = acc.role.toUpperCase();

  const managed = findAccount(getManagedId());
  if(managed && managed.id !== acc.id){
    managedBadge.style.display = "inline-block";
    managedBadge.textContent = `Managing: ${managed.name}`;
  }else{
    managedBadge.style.display = "none";
  }
}

/* ===================== Dashboard ===================== */
function renderDashboard(){
  hydrateSessionUI();
  const sess = getSession();
  if(!sess){ showPage("login"); return; }

  const me = findAccount(sess.accountId);
  if(!me){ logout(); return; }

  if(me.role==="coach"){
    coachPanel.style.display = "block";
    subscriberPanel.style.display = "none";
    dashHint.textContent = "Coach: تقدر تضيف مشتركين تحت حسابك وتتحكم بجميع بياناتهم.";
    renderManageList();
  }else{
    coachPanel.style.display = "none";
    subscriberPanel.style.display = "block";
    dashHint.textContent = "Subscriber: قراءة فقط (Workouts + Calculator)، وتكتب (Weekly + Weight) + تعدّل Max Weight بالتمارين.";
  }

  applyPermissions();
}

function renderManageList(){
  const sess = getSession();
  const me = findAccount(sess.accountId);
  const accounts = getAccounts();
  const mineSubs = accounts.filter(a=>a.role==="subscriber" && a.coachId===me.id);

  manageSelect.innerHTML = "";
  mineSubs.forEach(s=>{
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = s.name;
    manageSelect.appendChild(opt);
  });
  if(mineSubs.length===0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No subscribers yet";
    manageSelect.appendChild(opt);
  }
}

function setManaged(){
  const sess = getSession();
  const me = findAccount(sess.accountId);
  if(!me || me.role!=="coach") return;

  const targetId = manageSelect.value;
  if(!targetId){ coachMsg.textContent = "لا يوجد مشترك."; return; }

  const target = findAccount(targetId);
  if(!target || target.coachId !== me.id){ coachMsg.textContent = "غير مسموح."; return; }

  setManagedId(target.id);
  coachMsg.textContent = `✅ Managing: ${target.name}`;
  hydrateSessionUI();
  applyPermissions();
}

function manageSelf(){
  const sess = getSession();
  const me = findAccount(sess.accountId);
  if(!me || me.role!=="coach") return;
  setManagedId(me.id);
  coachMsg.textContent = "✅ Managing your coach profile.";
  hydrateSessionUI();
  applyPermissions();
}

async function createSubscriber(){
  coachMsg.textContent = "";
  const sess = getSession();
  const me = findAccount(sess.accountId);
  if(!me || me.role!=="coach"){ coachMsg.textContent="غير مسموح."; return; }

  const name = (subName.value||"").trim().replace(/\s+/g," ").slice(0,24);
  const pin = (subPin.value||"").trim();
  if(!name){ coachMsg.textContent="اكتب اسم المشترك."; return; }
  if(!pinValid6(pin)){ coachMsg.textContent="PIN لازم يكون 6 أرقام."; return; }

  const accounts = getAccounts();
  if(accounts.some(a => a.name.toLowerCase()===name.toLowerCase() && a.role==="subscriber" && a.coachId===me.id)){
    coachMsg.textContent="اسم المشترك موجود عندك.";
    return;
  }

  const id = uid();
  const pinHash = await sha256(pin);
  accounts.push({ id, name, role:"subscriber", coachId: me.id, pinHash });
  saveAccounts(accounts);

  subName.value = "";
  subPin.value = "";
  coachMsg.innerHTML = `✅ Created subscriber: <b>${name}</b>`;
  renderManageList();
  renderLoginAccounts();
}

function deleteManagedSubscriber(){
  coachMsg.textContent = "";
  const sess = getSession();
  const me = findAccount(sess.accountId);
  if(!me || me.role!=="coach"){ coachMsg.textContent="غير مسموح."; return; }

  const mid = getManagedId();
  const m = findAccount(mid);
  if(!m){ coachMsg.textContent="لا يوجد Managed."; return; }
  if(m.role!=="subscriber"){ coachMsg.textContent="تقدر تحذف المشترك فقط."; return; }
  if(m.coachId !== me.id){ coachMsg.textContent="غير مسموح."; return; }

  if(!confirm(`Delete subscriber: ${m.name}?`)) return;

  let accounts = getAccounts().filter(a => a.id !== m.id);
  saveAccounts(accounts);

  setManagedId(me.id);
  coachMsg.textContent = `✅ Deleted ${m.name}`;
  renderManageList();
  renderLoginAccounts();
  hydrateSessionUI();
  applyPermissions();
}

/* ===================== Permissions ===================== */
function isCoachSession(){ const s=getSession(); return !!s && s.role==="coach"; }
function isSubscriberSession(){ const s=getSession(); return !!s && s.role==="subscriber"; }

function canEditEverything(){
  if(!isCoachSession()) return false;
  const sess = getSession();
  const me = findAccount(sess.accountId);
  const managed = findAccount(getManagedId());
  if(!me || !managed) return false;
  if(managed.id === me.id) return true;
  return managed.role==="subscriber" && managed.coachId===me.id;
}

// NEW: subscriber can edit Max Weight ONLY (for their own profile)
function canEditMaxWeightOnly(){
  if(!isSubscriberSession()) return false;
  const sess = getSession();
  return getManagedId() === sess.accountId; // subscriber only edits self
}

function canEditMaxWeight(){
  return canEditEverything() || canEditMaxWeightOnly();
}

function setDisabled(el, disabled){
  if(!el) return;
  el.disabled = disabled;
  el.style.opacity = disabled ? 0.75 : 1;
}

function applyPermissions(){
  const sess = getSession();
  if(!sess){ tabsBar.style.display="none"; return; }

  hydrateSessionUI();

  if(canEditEverything()){
    calcModeHint.textContent = "Coach mode: you can edit all fields for the managed profile.";
    workHint.textContent = "Coach mode: you can edit workouts for the managed profile.";
  }else{
    calcModeHint.textContent = "Subscriber mode: read-only (you can still press Calculate).";
    workHint.textContent = "Subscriber mode: you can edit Max Weight only.";
  }

  // Calculator fields (coach only)
  const calcFields = [weightEl,heightEl,ageEl,genderEl,activityDaysEl,goalEl,proteinFactorEl,mealsEl,weeklyGoalEl];
  calcFields.forEach(f => setDisabled(f, !canEditEverything()));

  // Workouts reset only for coach
  resetWorkoutsBtn.style.display = canEditEverything() ? "block" : "none";
  resetWeekBtn.style.display = canEditEverything() ? "block" : "none";
  resetWeightBtn.style.display = canEditEverything() ? "block" : "none";

  tabsBar.style.display = "flex";
}

/* ===================== Calculator ===================== */
const weightEl = document.getElementById("weight");
const heightEl = document.getElementById("height");
const ageEl = document.getElementById("age");
const genderEl = document.getElementById("gender");
const activityDaysEl = document.getElementById("activityDays");
const goalEl = document.getElementById("goal");
const proteinFactorEl = document.getElementById("proteinFactor");
const mealsEl = document.getElementById("meals");
const weeklyGoalEl = document.getElementById("weeklyGoal");

const resultsCalc = document.getElementById("resultsCalc");
const outCalories = document.getElementById("outCalories");
const outMacros = document.getElementById("outMacros");
const outPerMeal = document.getElementById("outPerMeal");
const outBurn = document.getElementById("outBurn");

for(let i=30;i<=200;i++){
  const opt=document.createElement("option");
  opt.value=i; opt.textContent=i+" kg";
  if(i===80) opt.selected=true;
  weightEl.appendChild(opt);
}
for(let i=130;i<=210;i++){
  const opt=document.createElement("option");
  opt.value=i; opt.textContent=i+" cm";
  if(i===170) opt.selected=true;
  heightEl.appendChild(opt);
}
for(let i=14;i<=80;i++){
  const opt=document.createElement("option");
  opt.value=i; opt.textContent=i+" years";
  if(i===30) opt.selected=true;
  ageEl.appendChild(opt);
}

function saveCalcToProfile(){
  const payload = {
    weight: weightEl.value, height: heightEl.value, age: ageEl.value, gender: genderEl.value,
    activityDays: activityDaysEl.value, goal: goalEl.value, proteinFactor: proteinFactorEl.value,
    meals: mealsEl.value, weeklyGoal: weeklyGoalEl.value
  };
  pset("calc_inputs", JSON.stringify(payload));
}
function loadCalcFromProfile(){
  const raw = pget("calc_inputs");
  if(!raw) return;
  try{
    const v = JSON.parse(raw);
    if(v.weight) weightEl.value = v.weight;
    if(v.height) heightEl.value = v.height;
    if(v.age) ageEl.value = v.age;
    if(v.gender) genderEl.value = v.gender;
    if(v.activityDays) activityDaysEl.value = v.activityDays;
    if(v.goal) goalEl.value = v.goal;
    if(v.proteinFactor) proteinFactorEl.value = v.proteinFactor;
    if(v.meals) mealsEl.value = v.meals;
    if(v.weeklyGoal) weeklyGoalEl.value = v.weeklyGoal;
  }catch(e){}
}

[weightEl,heightEl,ageEl,genderEl,activityDaysEl,goalEl,proteinFactorEl,mealsEl,weeklyGoalEl]
.forEach(el=>{
  el.addEventListener("change", ()=>{
    if(canEditEverything()) saveCalcToProfile();
  });
});

function calculate(){
  const weight = parseFloat(weightEl.value);
  const height = parseFloat(heightEl.value);
  const age = parseFloat(ageEl.value);
  const gender = genderEl.value;
  const activityDays = parseInt(activityDaysEl.value,10);
  const goal = goalEl.value;
  const proteinFactor = parseFloat(proteinFactorEl.value);
  const meals = parseInt(mealsEl.value,10);
  const weeklyGoalKg = parseFloat(weeklyGoalEl.value);

  const bmr = (gender === "male")
    ? (10*weight + 6.25*height - 5*age + 5)
    : (10*weight + 6.25*height - 5*age - 161);

  let activityMult = 1.2 + (activityDays - 1) * 0.1;
  if(activityMult > 1.9) activityMult = 1.9;

  let calories = bmr * activityMult;
  if(goal === "cut") calories -= 500;
  if(goal === "bulk") calories += 500;

  const protein = weight * proteinFactor;
  const fat = weight * 0.8;
  const carbs = (calories - (protein*4 + fat*9)) / 4;

  const proteinMeal = protein / meals;
  const carbsMeal = carbs / meals;
  const fatMeal = fat / meals;

  const chickenGrams = proteinMeal * 4;
  const riceGrams = carbsMeal * 3.5;
  const oilGrams = fatMeal;

  const weeklyTarget = weeklyGoalKg * 7700;
  const dailyBurn = weeklyTarget / 7;

  outCalories.textContent = `Daily Calories: ${Math.round(calories)} kcal`;
  outMacros.innerHTML = `Protein: ${Math.round(protein)} g<br>Carbs: ${Math.round(carbs)} g<br>Fat: ${Math.round(fat)} g`;
  outPerMeal.innerHTML =
    `Per Meal (${meals} meals):<br><br>`+
    `Protein: ${Math.round(proteinMeal)} g ≈ ${Math.round(chickenGrams)} g chicken<br>`+
    `Carbs: ${Math.round(carbsMeal)} g ≈ ${Math.round(riceGrams)} g rice<br>`+
    `Fat: ${Math.round(fatMeal)} g ≈ ${Math.round(oilGrams)} g oil`;
  outBurn.textContent = `Calories to burn daily to reach weekly goal: ${Math.round(dailyBurn)} kcal`;

  resultsCalc.style.display = "block";

  if(canEditEverything()){
    pset("weekly_target", String(weeklyTarget));
    saveCalcToProfile();
  }
  syncWeeklyTargetUI();
}
document.getElementById("calcBtn").addEventListener("click", calculate);

/* ===================== Weekly Burn Tracker ===================== */
const weeklyTargetLabel = document.getElementById("weeklyTargetLabel");
const daysGrid = document.getElementById("daysGrid");
const todayIndexEl = document.getElementById("todayIndex");
const wkBurned = document.getElementById("wkBurned");
const wkRemaining = document.getElementById("wkRemaining");
const wkPerDay = document.getElementById("wkPerDay");
const wkTomorrow = document.getElementById("wkTomorrow");
const wkWarn = document.getElementById("wkWarn");

function buildDays(){
  daysGrid.innerHTML = "";
  for(let d=1; d<=7; d++){
    const wrap = document.createElement("div");
    const lbl = document.createElement("label");
    lbl.textContent = `Day ${d} burned (kcal)`;
    lbl.style.marginTop = "0";

    const inp = document.createElement("input");
    inp.type = "number";
    inp.min = "0";
    inp.step = "10";
    inp.id = `day_${d}`;
    inp.placeholder = "0";

    inp.addEventListener("input", () => {
      // subscribers can write logs
      pset(`day_${d}`, inp.value || "");
      recalcWeek();
    });

    wrap.appendChild(lbl);
    wrap.appendChild(inp);
    daysGrid.appendChild(wrap);
  }

  todayIndexEl.addEventListener("change", () => {
    pset("today_index", todayIndexEl.value);
    recalcWeek();
  });
}

function rebuildWeekInputsFromStorage(){
  for(let d=1; d<=7; d++){
    const el = document.getElementById(`day_${d}`);
    if(!el) continue;
    el.value = pget(`day_${d}`) ?? "";
  }
  const savedToday = pget("today_index");
  if(savedToday) todayIndexEl.value = savedToday;
}

function getWeeklyTarget(){
  const v = pget("weekly_target");
  if(!v) return 0;
  const n = parseFloat(v);
  return isFinite(n) ? n : 0;
}
function syncWeeklyTargetUI(){
  const target = getWeeklyTarget();
  weeklyTargetLabel.textContent = `Weekly target burn: ${target>0 ? Math.round(target) : "--"} kcal`;
}
function recalcWeek(){
  const target = getWeeklyTarget();
  if(target <= 0){
    wkWarn.textContent = "⚠️ Coach لازم يحسب من الحاسبة أولاً عشان ينعرف هدف الأسبوع.";
    wkBurned.textContent = "Burned so far: --";
    wkRemaining.textContent = "Remaining: --";
    wkPerDay.textContent = "Required per remaining day: --";
    wkTomorrow.textContent = "Tomorrow target: --";
    return;
  } else wkWarn.textContent = "";

  let burned = 0;
  for(let d=1; d<=7; d++){
    const val = parseFloat((document.getElementById(`day_${d}`).value || "").trim());
    if(!isNaN(val) && val > 0) burned += val;
  }

  const remaining = Math.max(0, target - burned);
  const today = parseInt(todayIndexEl.value,10);
  const remainingDaysAfterToday = Math.max(0, 7 - today);
  const requiredPerDay = remainingDaysAfterToday > 0 ? (remaining / remainingDaysAfterToday) : remaining;

  wkBurned.textContent = `Burned so far: ${Math.round(burned)} kcal`;
  wkRemaining.textContent = `Remaining to reach weekly target: ${Math.round(remaining)} kcal`;

  if(remainingDaysAfterToday > 0){
    wkPerDay.textContent = `Required per day for remaining days (${remainingDaysAfterToday}): ${Math.round(requiredPerDay)} kcal/day`;
    wkTomorrow.textContent = `Tomorrow target burn: ${Math.round(requiredPerDay)} kcal`;
  } else {
    wkPerDay.textContent = `Week finished. Remaining: ${Math.round(remaining)} kcal`;
    wkTomorrow.textContent = `Tomorrow target: 0 kcal`;
  }
}
function resetWeek(){
  if(!canEditEverything()) return;
  for(let d=1; d<=7; d++){
    premove(`day_${d}`);
    const el = document.getElementById(`day_${d}`);
    if(el) el.value = "";
  }
  premove("today_index");
  todayIndexEl.value = "1";
  recalcWeek();
}

/* ===================== Workouts ===================== */
const workoutContainer = document.getElementById("workoutContainer");
const weekDays = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

function defaultWorkouts(){
  const obj = {};
  weekDays.forEach(d => obj[d] = []);
  return obj;
}
function loadWorkouts(){
  const raw = pget("workouts");
  if(!raw) return defaultWorkouts();
  try{
    const parsed = JSON.parse(raw);
    weekDays.forEach(d => { if(!Array.isArray(parsed[d])) parsed[d] = []; });
    return parsed;
  }catch(e){ return defaultWorkouts(); }
}
function saveWorkouts(data){ pset("workouts", JSON.stringify(data)); }

function addExercise(day){
  if(!canEditEverything()) return;
  const data = loadWorkouts();
  data[day].push({ name:"", sets:3, maxWeight:0 });
  saveWorkouts(data);
  renderWorkouts();
}
function deleteExercise(day, idx){
  if(!canEditEverything()) return;
  const data = loadWorkouts();
  data[day].splice(idx,1);
  saveWorkouts(data);
  renderWorkouts();
}
function updateExercise(day, idx, key, value){
  // Coach: all keys
  if(canEditEverything()){
    const data = loadWorkouts();
    if(!data[day] || !data[day][idx]) return;
    data[day][idx][key] = value;
    saveWorkouts(data);
    return;
  }
  // Subscriber: maxWeight only
  if(canEditMaxWeightOnly() && key === "maxWeight"){
    const data = loadWorkouts();
    if(!data[day] || !data[day][idx]) return;
    data[day][idx].maxWeight = value;
    saveWorkouts(data);
  }
}

function toggleDay(day){
  const safe = day.replace(/\s+/g,"_");
  const content = document.getElementById(`content_${safe}`);
  const chev = document.getElementById(`chev_${safe}`);
  const isOpen = content.classList.toggle("open");
  content.style.display = isOpen ? "block" : "none";
  chev.textContent = isOpen ? "▲" : "▼";
  pset(`day_open_${safe}`, isOpen ? "1" : "0");
}

function renderWorkouts(){
  const data = loadWorkouts();
  workoutContainer.innerHTML = "";

  weekDays.forEach(day=>{
    const safe = day.replace(/\s+/g,"_");

    const card = document.createElement("div");
    card.className = "day-card";

    const header = document.createElement("div");
    header.className = "day-header";

    const left = document.createElement("div");
    left.className = "day-name";
    left.textContent = day;

    const chev = document.createElement("div");
    chev.className = "chev";
    chev.id = `chev_${safe}`;

    header.appendChild(left);
    header.appendChild(chev);
    header.onclick = () => toggleDay(day);
    card.appendChild(header);

    const content = document.createElement("div");
    content.className = "day-content";
    content.id = `content_${safe}`;

    const openState = pget(`day_open_${safe}`);
    const open = openState === "1";
    content.style.display = open ? "block" : "none";
    chev.textContent = open ? "▲" : "▼";
    if(open) content.classList.add("open");

    // Add button only for coach
    if(canEditEverything()){
      const actions = document.createElement("div");
      actions.className = "row-actions";
      const addBtn = document.createElement("button");
      addBtn.className = "add-btn";
      addBtn.textContent = "+ Add Exercise";
      addBtn.onclick = (e)=>{ e.stopPropagation(); addExercise(day); };
      actions.appendChild(addBtn);
      content.appendChild(actions);
    }

    if(data[day].length === 0){
      const empty = document.createElement("div");
      empty.className = "small-note";
      empty.textContent = "No exercises yet.";
      content.appendChild(empty);
    } else {
      data[day].forEach((ex, idx)=>{
        const row = document.createElement("div");
        row.className = "exercise";

        const name = document.createElement("input");
        name.className = "exercise-name";
        name.placeholder = "Exercise";
        name.value = ex.name || "";
        name.oninput = (ev)=> updateExercise(day, idx, "name", ev.target.value);
        // subscriber cannot edit name
        setDisabled(name, !canEditEverything());

        const setsCounter = document.createElement("div");
        setsCounter.className = "counter";

        const setsMinus = document.createElement("button");
        setsMinus.textContent = "-";
        setsMinus.onclick = ()=>{
          const cur = parseInt(ex.sets ?? 3, 10);
          if(cur > 1){
            updateExercise(day, idx, "sets", cur - 1);
            renderWorkouts();
          }
        };
        setDisabled(setsMinus, !canEditEverything());

        const setsValue = document.createElement("span");
        setsValue.textContent = `S:${parseInt(ex.sets ?? 3,10)}`;

        const setsPlus = document.createElement("button");
        setsPlus.textContent = "+";
        setsPlus.onclick = ()=>{
          const cur = parseInt(ex.sets ?? 3, 10);
          updateExercise(day, idx, "sets", cur + 1);
          renderWorkouts();
        };
        setDisabled(setsPlus, !canEditEverything());

        setsCounter.appendChild(setsMinus);
        setsCounter.appendChild(setsValue);
        setsCounter.appendChild(setsPlus);

        const weightCounter = document.createElement("div");
        weightCounter.className = "counter";

        const weightMinus = document.createElement("button");
        weightMinus.textContent = "-";
        weightMinus.onclick = ()=>{
          let w = parseFloat(ex.maxWeight ?? 0);
          if(!isFinite(w)) w = 0;
          w = Math.max(0, w - 2.5);
          updateExercise(day, idx, "maxWeight", w);
          renderWorkouts();
        };
        setDisabled(weightMinus, !canEditMaxWeight());

        const weightValue = document.createElement("span");
        const wShow = parseFloat(ex.maxWeight ?? 0);
        weightValue.textContent = `W:${(isFinite(wShow)?wShow:0)}kg`;

        const weightPlus = document.createElement("button");
        weightPlus.textContent = "+";
        weightPlus.onclick = ()=>{
          let w = parseFloat(ex.maxWeight ?? 0);
          if(!isFinite(w)) w = 0;
          w = w + 2.5;
          updateExercise(day, idx, "maxWeight", w);
          renderWorkouts();
        };
        setDisabled(weightPlus, !canEditMaxWeight());

        weightCounter.appendChild(weightMinus);
        weightCounter.appendChild(weightValue);
        weightCounter.appendChild(weightPlus);

        row.appendChild(name);
        row.appendChild(setsCounter);
        row.appendChild(weightCounter);

        // delete only for coach
        if(canEditEverything()){
          const del = document.createElement("button");
          del.className = "del-btn";
          del.textContent = "X";
          del.onclick = ()=> deleteExercise(day, idx);
          row.appendChild(del);
        }

        content.appendChild(row);
      });
    }

    card.appendChild(content);
    workoutContainer.appendChild(card);
  });
}

function resetWorkouts(){
  if(!canEditEverything()) return;
  if(!confirm("Reset workouts for this profile?")) return;
  premove("workouts");
  weekDays.forEach(day=>{
    const safe = day.replace(/\s+/g,"_");
    premove(`day_open_${safe}`);
  });
  renderWorkouts();
}

/* ===================== Weight Tracker ===================== */
const weightWeeksEl = document.getElementById("weightWeeks");
const weightRowsEl = document.getElementById("weightRows");
const wStartEl = document.getElementById("wStart");
const wCurrentEl = document.getElementById("wCurrent");
const wChangeEl = document.getElementById("wChange");
const wAvgEl = document.getElementById("wAvg");

for(let w=4; w<=52; w++){
  const opt=document.createElement("option");
  opt.value=String(w);
  opt.textContent = `${w} weeks`;
  if(w===12) opt.selected=true;
  weightWeeksEl.appendChild(opt);
}
weightWeeksEl.addEventListener("change", ()=>{
  pset("weight_weeks", weightWeeksEl.value);
  renderWeightRows();
  calcWeightSummary();
});

function getWeightWeeks(){
  const saved = pget("weight_weeks");
  const n = parseInt(saved || weightWeeksEl.value || "12", 10);
  if(!isFinite(n) || n<4) return 12;
  return Math.min(52, n);
}

function loadWeightTracker(){
  const savedWeeks = pget("weight_weeks");
  if(savedWeeks) weightWeeksEl.value = savedWeeks;

  renderWeightRows();
  calcWeightSummary();
}

function renderWeightRows(){
  const weeks = getWeightWeeks();
  weightRowsEl.innerHTML = "";

  for(let i=1; i<=weeks; i++){
    const row = document.createElement("div");
    row.className = "wrow";

    const tag = document.createElement("div");
    tag.className = "wtag";
    tag.innerHTML = `<b>Week ${i}</b>`;

    const inp = document.createElement("input");
    inp.type = "number";
    inp.min = "0";
    inp.step = "0.1";
    inp.placeholder = "Weight (kg)";
    inp.value = pget(`w_week_${i}`) ?? "";

    // coach + subscriber can write weight logs
    inp.addEventListener("input", ()=>{
      pset(`w_week_${i}`, inp.value || "");
      calcWeightSummary();
    });

    row.appendChild(tag);
    row.appendChild(inp);
    weightRowsEl.appendChild(row);
  }
}

function calcWeightSummary(){
  const weeks = getWeightWeeks();

  let start = null;
  let last = null;
  let lastWeekIndex = null;

  for(let i=1; i<=weeks; i++){
    const v = parseFloat((pget(`w_week_${i}`) || "").trim());
    if(isFinite(v) && v > 0){
      if(start === null) start = v;
      last = v;
      lastWeekIndex = i;
    }
  }

  if(start === null || last === null){
    wStartEl.textContent = "Start: --";
    wCurrentEl.textContent = "Current: --";
    wChangeEl.textContent = "Change: --";
    wAvgEl.textContent = "Avg / Week: --";
    return;
  }

  const change = last - start;
  const weeksPassed = Math.max(1, (lastWeekIndex - 1));
  const avg = change / weeksPassed;

  wStartEl.textContent = `Start: ${start.toFixed(1)} kg`;
  wCurrentEl.textContent = `Current: ${last.toFixed(1)} kg (Week ${lastWeekIndex})`;
  wChangeEl.textContent = `Change: ${change.toFixed(1)} kg`;
  wAvgEl.textContent = `Avg / Week: ${avg.toFixed(2)} kg/week`;
}

function resetWeight(){
  if(!canEditEverything()) return; // coach only
  if(!confirm("Reset weight log for this profile?")) return;
  const weeks = getWeightWeeks();
  for(let i=1; i<=weeks; i++) premove(`w_week_${i}`);
  renderWeightRows();
  calcWeightSummary();
}

/* ===================== Weekly Target label helper ===================== */
function getWeeklyTarget(){
  const v = pget("weekly_target");
  if(!v) return 0;
  const n = parseFloat(v);
  return isFinite(n) ? n : 0;
}
function syncWeeklyTargetUI(){
  const target = getWeeklyTarget();
  weeklyTargetLabel.textContent = `Weekly target burn: ${target>0 ? Math.round(target) : "--"} kcal`;
}

/* ===================== INIT ===================== */
function init(){
  renderLoginAccounts();
  buildDays();

  const sess = getSession();
  if(sess){
    hydrateSessionUI();
    tabsBar.style.display = "flex";
    if(!getManagedId()) setManagedId(sess.accountId);
    showPage("dashboard");
  }else{
    tabsBar.style.display = "none";
    showPage("login");
  }
}
init();
</script>
</body>
</html>
