<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WS Fitness</title>
<style>
  body{margin:0;padding:18px;font-family:Arial,sans-serif;background:linear-gradient(135deg,#0f172a,#1e293b);color:#fff}
  h1{margin:0 0 12px;text-align:center;color:#38bdf8}
  .pill{background:#0b1220;border-radius:14px;padding:10px 12px;display:flex;gap:10px;justify-content:space-between;align-items:center;margin-bottom:12px}
  .pill b{color:#38bdf8}
  .badge{border:1px solid #334155;border-radius:999px;padding:6px 10px;font-size:12px;background:#0b1220}
  .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 14px}
  .tab{flex:1;min-width:120px;border:0;border-radius:12px;padding:12px;font-weight:800;cursor:pointer;background:#1e293b;color:#fff}
  .tab.active{background:linear-gradient(90deg,#0ea5e9,#2563eb)}
  .box{background:#1e293b;border-radius:12px;padding:14px;margin-bottom:12px;line-height:1.7}
  .small{font-size:13px;opacity:.9;margin-top:6px}
  .danger{color:#fecaca}
  .ok{color:#bbf7d0}
  .muted{opacity:.85}
  label{display:block;margin-top:12px;font-weight:800}
  select,input{
    width:100%;margin-top:6px;padding:12px;border:0;border-radius:12px;background:#0f172a;color:#fff;font-size:15px;outline:none
  }
  select::-webkit-scrollbar{width:7px}
  select::-webkit-scrollbar-track{background:#0b1220;border-radius:10px}
  select::-webkit-scrollbar-thumb{background:#2563eb;border-radius:10px}
  button.primary{
    width:100%;margin-top:14px;padding:15px;border:0;border-radius:14px;background:linear-gradient(90deg,#0ea5e9,#2563eb);
    color:#fff;font-size:17px;font-weight:900;cursor:pointer
  }
  button.mini{
    width:100%;margin-top:10px;padding:12px;border:0;border-radius:12px;background:#0b1220;color:#fff;font-weight:900;cursor:pointer
  }
  button.red{background:#ef4444 !important}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row>*{flex:1;min-width:160px}
  .page{display:none}
  .page.active{display:block}
  .hidden{display:none!important}
  .results{background:#0b1220;border-radius:14px;padding:12px;margin-top:10px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  @media(max-width:540px){.grid{grid-template-columns:1fr}}

  /* workouts compact */
  .day-card{background:#0b1220;border-radius:14px;padding:12px;margin-bottom:12px}
  .day-head{display:flex;justify-content:space-between;align-items:center;background:#0f172a;border-radius:12px;padding:10px;cursor:pointer}
  .day-name{color:#38bdf8;font-weight:900}
  .exercise{background:#1e293b;border-radius:12px;padding:8px 10px;margin-top:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .exercise input{margin:0;border-radius:10px}
  .exercise-name{flex:1;min-width:180px}
  .counter{display:flex;align-items:center;gap:4px;background:#0f172a;border-radius:10px;padding:4px 6px;white-space:nowrap}
  .counter button{background:#2563eb;border:0;color:#fff;width:28px;height:28px;border-radius:8px;font-weight:900;cursor:pointer}
  .counter span{min-width:70px;text-align:center;font-weight:900}
  .delbtn{background:#ef4444;border:0;color:#fff;width:34px;height:34px;border-radius:10px;font-weight:900;cursor:pointer}

  /* weight rows */
  .wrow{background:#1e293b;border-radius:12px;padding:10px;margin-top:10px;display:flex;gap:10px;align-items:center}
  .wtag{background:#0f172a;border-radius:10px;padding:8px 10px;font-weight:900;min-width:92px;text-align:center}
  .wrow input{margin:0}
</style>
</head>

<body>
<h1>WS Fitness</h1>

<div class="pill">
  <div>
    Session: <b id="sessName">—</b>
    <span class="badge" id="sessRole">—</span>
    <span class="badge" id="adminBadge" style="display:none;">ADMIN</span>
    <span class="badge" id="managedBadge" style="display:none;"></span>
  </div>
  <button class="mini" style="max-width:170px;margin:0" onclick="logout()">Logout</button>
</div>

<div class="tabs" id="tabs" style="display:none;">
  <button class="tab active" id="tProfile" onclick="go('profile')">Profile</button>
  <button class="tab" id="tCalc" onclick="go('calc')">Calculator</button>
  <button class="tab" id="tWork" onclick="go('work')">Workouts</button>
  <button class="tab" id="tWeek" onclick="go('week')">Weekly</button>
  <button class="tab" id="tWeight" onclick="go('weight')">Weight</button>
  <button class="tab hidden" id="tAdmin" onclick="go('admin')">Admin</button>
</div>

<!-- LOGIN -->
<div class="page active" id="pLogin">
  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Login</div>
    <div class="small">اختر حساب ثم ادخل PIN (6 أرقام). Admin ثابت موجود تلقائيًا (PIN: 123456) إذا أول مرة.</div>
  </div>

  <label>Account</label>
  <select id="loginSel"></select>

  <label>PIN (6 digits)</label>
  <input id="loginPin" type="password" inputmode="numeric" maxlength="6" placeholder="******" />

  <button class="primary" onclick="login()">Login</button>
  <div class="small danger" id="loginMsg"></div>

  <div class="box" style="margin-top:14px;">
    <div style="font-weight:900;color:#38bdf8">Reset (اختياري)</div>
    <button class="mini red" onclick="resetAll()">Reset All Data (wipe)</button>
    <div class="small danger">يمسح كل الحسابات والبيانات من الجهاز.</div>
  </div>
</div>

<!-- PROFILE -->
<div class="page" id="pProfile">

  <!-- Coach/Admin profile -->
  <div id="profileCoach" class="hidden">
    <div class="box">
      <div style="font-weight:900;color:#38bdf8">Profile (Coach/Admin)</div>
      <div class="small muted">اختيار Managed يحدد لمن سيتم تعديل الصفحات (Calculator/Workouts/Weekly/Weight).</div>

      <label>Managed Profile</label>
      <select id="managedSel"></select>
      <button class="mini" onclick="setManaged()">Set Managed</button>

      <div class="small ok" id="managedMsg"></div>
    </div>

    <div class="box">
      <div style="font-weight:900;color:#38bdf8">Your PIN</div>
      <label>Change My PIN</label>
      <input id="myNewPin" type="password" inputmode="numeric" maxlength="6" placeholder="******" />
      <button class="mini" onclick="changeMyPin()">Change</button>
      <div class="small danger" id="myPinMsg"></div>
    </div>

    <div class="box" id="coachSubTools">
      <div style="font-weight:900;color:#38bdf8">Subscribers (Coach tools)</div>
      <div class="small muted">المدرب يضيف/يحذف/Reset PIN لمشتركينه فقط.</div>

      <div class="row">
        <div>
          <label>Subscriber Name</label>
          <input id="cSubName" placeholder="Example: Ahmed" />
        </div>
        <div>
          <label>Subscriber PIN (6 digits)</label>
          <input id="cSubPin" type="password" inputmode="numeric" maxlength="6" placeholder="******" />
        </div>
      </div>
      <button class="mini" onclick="coachAddSubscriber()">Add Subscriber</button>
      <div class="small danger" id="cSubMsg"></div>

      <label>My Subscribers</label>
      <select id="cMySubsSel"></select>

      <div class="row">
        <div>
          <label>New PIN for selected</label>
          <input id="cResetPin" type="password" inputmode="numeric" maxlength="6" placeholder="******" />
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="mini" style="margin-top:6px" onclick="coachResetSubPin()">Reset PIN</button>
        </div>
      </div>

      <button class="mini red" onclick="coachDeleteSub()">Delete Subscriber</button>
      <div class="small danger" id="cSubOpsMsg"></div>
    </div>
  </div>

  <!-- Subscriber profile -->
  <div id="profileSub" class="hidden">
    <div class="box">
      <div style="font-weight:900;color:#38bdf8">Your Results</div>
      <div class="small">تشوف النتائج فقط. المدرب يعدّل الخطة من عنده.</div>

      <div class="results" id="subResults">
        <div id="subCal">Daily Calories: --</div>
        <hr style="border:0;border-top:1px solid #334155;margin:10px 0">
        <div id="subMacros">Protein/Carbs/Fat: --</div>
        <hr style="border:0;border-top:1px solid #334155;margin:10px 0">
        <div id="subPerMeal">Per Meal: --</div>
        <hr style="border:0;border-top:1px solid #334155;margin:10px 0">
        <div id="subBurn">Daily Burn Target: --</div>
        <div class="small danger" id="subWarn"></div>
      </div>
    </div>
  </div>
</div>

<!-- CALC -->
<div class="page" id="pCalc">
  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Calculator</div>
    <div class="small muted" id="calcHint"></div>
  </div>

  <div id="calcInputsWrap">
    <label>Weight</label>
    <select id="weight"></select>

    <label>Height</label>
    <select id="height"></select>

    <label>Age</label>
    <select id="age"></select>

    <label>Gender</label>
    <select id="gender">
      <option value="male">Male</option>
      <option value="female">Female</option>
    </select>

    <label>Activity Days</label>
    <select id="activityDays">
      <option value="1">1</option><option value="2">2</option><option value="3">3</option>
      <option value="4">4</option><option value="5">5</option><option value="6">6</option>
    </select>

    <label>Goal</label>
    <select id="goal">
      <option value="cut">Cut</option>
      <option value="maintain">Maintain</option>
      <option value="bulk">Bulk</option>
    </select>

    <label>Protein Multiplier</label>
    <select id="proteinFactor">
      <option value="1.5">1.5</option><option value="1.8">1.8</option><option value="2">2</option>
      <option value="2.2">2.2</option><option value="2.5">2.5</option><option value="2.8">2.8</option>
      <option value="3">3</option>
    </select>

    <label>Meals</label>
    <select id="meals">
      <option value="2">2</option><option value="3">3</option><option value="4">4</option>
      <option value="5">5</option><option value="6">6</option>
    </select>

    <label>Weekly Goal</label>
    <select id="weeklyGoal">
      <option value="0.5">0.5 kg</option><option value="1">1 kg</option><option value="1.5">1.5 kg</option>
      <option value="2">2 kg</option>
    </select>

    <button class="primary" id="calcBtn">Calculate & Save</button>
  </div>

  <div class="results" id="calcResults" style="display:block;">
    <div id="outCalories">Daily Calories: --</div>
    <hr style="border:0;border-top:1px solid #334155;margin:10px 0">
    <div id="outMacros">Protein/Carbs/Fat: --</div>
    <hr style="border:0;border-top:1px solid #334155;margin:10px 0">
    <div id="outPerMeal">Per Meal: --</div>
    <hr style="border:0;border-top:1px solid #334155;margin:10px 0">
    <div id="outBurn">Daily Burn Target: --</div>
  </div>
</div>

<!-- WORKOUTS -->
<div class="page" id="pWork">
  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Workouts</div>
    <div class="small muted" id="workHint"></div>
  </div>

  <div id="workContainer"></div>
  <button class="mini red hidden" id="workResetBtn" onclick="resetWorkouts()">Reset workouts (coach/admin)</button>
</div>

<!-- WEEKLY BURN -->
<div class="page" id="pWeek">
  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Weekly Burn Tracker</div>
    <div class="small" id="weeklyTargetLabel">Weekly target burn: -- kcal</div>
    <div class="small muted">المشترك يكتب Burn لكل يوم. المدرب يحدد الهدف من الحاسبة.</div>
  </div>

  <label>Today</label>
  <select id="todayIndex">
    <option value="1">Day 1</option><option value="2">Day 2</option><option value="3">Day 3</option>
    <option value="4">Day 4</option><option value="5">Day 5</option><option value="6">Day 6</option><option value="7">Day 7</option>
  </select>

  <div class="grid" id="daysGrid"></div>
  <button class="mini" onclick="recalcWeek()">Update</button>
  <button class="mini red hidden" id="weekResetBtn" onclick="resetWeek()">Reset week (coach/admin)</button>

  <div class="results">
    <div id="wkBurned">Burned so far: --</div>
    <div id="wkRemaining">Remaining: --</div>
    <div id="wkPerDay">Required per remaining day: --</div>
    <div id="wkTomorrow">Tomorrow target: --</div>
    <div class="small danger" id="wkWarn"></div>
  </div>
</div>

<!-- WEIGHT -->
<div class="page" id="pWeight">
  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Weight Tracker</div>
    <div class="small muted">المشترك يكتب وزن كل أسبوع.</div>
  </div>

  <label>Duration (Weeks)</label>
  <select id="weightWeeks"></select>

  <div class="results">
    <div id="wStart">Start: --</div>
    <div id="wCurrent">Current: --</div>
    <div id="wChange">Change: --</div>
    <div id="wAvg">Avg / Week: --</div>
  </div>

  <div id="weightRows"></div>
  <button class="mini red hidden" id="weightResetBtn" onclick="resetWeight()">Reset weight log (coach/admin)</button>
</div>

<!-- ADMIN PANEL -->
<div class="page" id="pAdmin">
  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Admin Panel</div>
    <div class="small muted">إنشاء المدربين + Reset PIN للمدربين + إدارة المشتركين بالكامل.</div>
  </div>

  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Admin PIN</div>
    <label>Change Admin PIN (6 digits)</label>
    <input id="adminNewPin" type="password" inputmode="numeric" maxlength="6" placeholder="******" />
    <button class="mini" onclick="changeAdminPin()">Change Admin PIN</button>
    <div class="small danger" id="adminPinMsg"></div>
  </div>

  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Create Coach Account</div>
    <div class="row">
      <div>
        <label>Coach Name</label>
        <input id="aCoachName" placeholder="Coach Name" />
      </div>
      <div>
        <label>Coach PIN (6 digits)</label>
        <input id="aCoachPin" type="password" inputmode="numeric" maxlength="6" placeholder="******" />
      </div>
    </div>
    <button class="mini" onclick="adminCreateCoach()">Create Coach</button>
    <div class="small danger" id="aCoachMsg"></div>
  </div>

  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Reset Coach PIN</div>
    <label>Select Coach</label>
    <select id="aCoachSel"></select>
    <label>New PIN</label>
    <input id="aCoachResetPin" type="password" inputmode="numeric" maxlength="6" placeholder="******" />
    <button class="mini" onclick="adminResetCoachPin()">Reset Coach PIN</button>
    <div class="small danger" id="aCoachResetMsg"></div>

    <button class="mini red" onclick="adminDeleteCoach(false)">Delete Coach (must have 0 subscribers)</button>
    <button class="mini red" onclick="adminDeleteCoach(true)">Delete Coach + ALL subscribers (Cascade)</button>
    <div class="small danger" id="aCoachDelMsg"></div>
  </div>

  <div class="box">
    <div style="font-weight:900;color:#38bdf8">Subscribers (Admin)</div>
    <label>Select Subscriber</label>
    <select id="aSubSel"></select>

    <div class="row">
      <div>
        <label>Reset Subscriber PIN</label>
        <input id="aSubResetPin" type="password" inputmode="numeric" maxlength="6" placeholder="******" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="mini" style="margin-top:6px" onclick="adminResetSubPin()">Reset</button>
      </div>
    </div>

    <label>Move Subscriber to Coach</label>
    <select id="aMoveToCoach"></select>
    <button class="mini" onclick="adminMoveSubscriber()">Move</button>

    <button class="mini red" onclick="adminDeleteSubscriber()">Delete Subscriber</button>

    <div class="small danger" id="aSubMsg"></div>
  </div>
</div>

<script>
/* =================== Core =================== */
const $ = (id)=>document.getElementById(id);
const PIN_RE = /^[0-9]{6}$/;

async function sha256(txt){
  const enc = new TextEncoder().encode(txt);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
function uid(){ return "id_"+Math.random().toString(16).slice(2)+Date.now().toString(16); }

function loadAccounts(){
  try{ return JSON.parse(localStorage.getItem("ws_accounts")||"[]"); }catch{ return []; }
}
function saveAccounts(a){ localStorage.setItem("ws_accounts", JSON.stringify(a)); }
function findAcc(id){ return loadAccounts().find(x=>x.id===id) || null; }

function setSession(obj){ localStorage.setItem("ws_session", JSON.stringify(obj)); }
function getSession(){ try{ return JSON.parse(localStorage.getItem("ws_session")||"null"); }catch{ return null; } }
function clearSession(){ localStorage.removeItem("ws_session"); }

function setManagedId(id){ localStorage.setItem("ws_managed_id", id); }
function getManagedId(){ return localStorage.getItem("ws_managed_id") || ""; }

/* per-profile storage keyed by managed id */
function pkey(key){ return `ws_p_${getManagedId()||"none"}_${key}`; }
function pget(key){ return localStorage.getItem(pkey(key)); }
function pset(key,val){ localStorage.setItem(pkey(key), val); }
function premove(key){ localStorage.removeItem(pkey(key)); }

/* Ensure fixed admin exists */
async function ensureAdmin(){
  const acc = loadAccounts();
  let admin = acc.find(a=>a.role==="admin");
  if(!admin){
    admin = { id:"admin_fixed", name:"WS Admin", role:"admin", pinHash: await sha256("123456") };
    acc.push(admin);
    saveAccounts(acc);
  }
}

/* roles */
function me(){ const s=getSession(); return s ? findAcc(s.id) : null; }
function isAdmin(){ const a=me(); return !!a && a.role==="admin"; }
function isCoach(){ const a=me(); return !!a && a.role==="coach"; }
function isSub(){ const a=me(); return !!a && a.role==="subscriber"; }

function canEditEverything(){
  // Admin can edit any managed profile
  if(isAdmin()) return true;
  if(!isCoach()) return false;
  const managed = findAcc(getManagedId());
  const a = me();
  if(!managed || !a) return false;
  if(managed.id === a.id) return true;
  return managed.role==="subscriber" && managed.coachId === a.id;
}
function canEditMaxWeightOnly(){
  if(!isSub()) return false;
  const a=me(); return a && getManagedId()===a.id;
}
function canEditMaxWeight(){ return canEditEverything() || canEditMaxWeightOnly(); }

/* =================== UI =================== */
function hydrateHeader(){
  const a=me();
  $("sessName").textContent = a ? a.name : "—";
  $("sessRole").textContent = a ? a.role.toUpperCase() : "—";
  $("adminBadge").style.display = isAdmin() ? "inline-block" : "none";

  const managed = findAcc(getManagedId());
  if(managed && a && managed.id !== a.id){
    $("managedBadge").style.display="inline-block";
    $("managedBadge").textContent = `Managing: ${managed.name}`;
  } else {
    $("managedBadge").style.display="none";
  }
}
function showTabs(){
  $("tabs").style.display="flex";
  $("tAdmin").classList.toggle("hidden", !isAdmin());
}
function go(which){
  ["Login","Profile","Calc","Work","Week","Weight","Admin"].forEach(p=> $("p"+p).classList.remove("active"));
  ["Profile","Calc","Work","Week","Weight","Admin"].forEach(t=> $("t"+t)?.classList.remove("active"));

  $("p"+which.charAt(0).toUpperCase()+which.slice(1)).classList.add("active");
  $("t"+which.charAt(0).toUpperCase()+which.slice(1))?.classList.add("active");

  if(which==="profile") renderProfile();
  if(which==="calc") { loadCalcInputs(); renderCalcMode(); renderCalcResults(); }
  if(which==="work") { renderWorkouts(); applyWorkButtons(); }
  if(which==="week") { buildWeekInputs(); loadWeekInputs(); syncWeeklyTarget(); recalcWeek(); applyWeekButtons(); }
  if(which==="weight"){ loadWeightTracker(); applyWeightButtons(); }
  if(which==="admin") { renderAdminPanel(); }

  hydrateHeader();
}
function showLogin(){
  $("tabs").style.display="none";
  ["Profile","Calc","Work","Week","Weight","Admin"].forEach(p=> $("p"+p)?.classList.remove("active"));
  $("pLogin").classList.add("active");
  renderLoginList();
  hydrateHeader();
}

/* =================== Login =================== */
function renderLoginList(){
  const acc=loadAccounts();
  const sel=$("loginSel");
  sel.innerHTML="";

  const admin = acc.filter(x=>x.role==="admin");
  const coaches = acc.filter(x=>x.role==="coach");
  const subs = acc.filter(x=>x.role==="subscriber");

  function addGroup(label, list){
    if(!list.length) return;
    const og=document.createElement("optgroup");
    og.label=label;
    list.forEach(a=>{
      const opt=document.createElement("option");
      opt.value=a.id;
      opt.textContent = a.name + (a.role==="subscriber" ? ` (Coach: ${findAcc(a.coachId)?.name||"—"})` : "");
      og.appendChild(opt);
    });
    sel.appendChild(og);
  }
  addGroup("Admin", admin);
  addGroup("Coaches", coaches);
  addGroup("Subscribers", subs);

  if(!acc.length){
    const opt=document.createElement("option"); opt.value=""; opt.textContent="No accounts"; sel.appendChild(opt);
  }
}
async function login(){
  $("loginMsg").textContent="";
  const id=$("loginSel").value;
  const pin=($("loginPin").value||"").trim();
  if(!id){ $("loginMsg").textContent="اختر حساب."; return; }
  if(!PIN_RE.test(pin)){ $("loginMsg").textContent="PIN لازم 6 أرقام."; return; }

  const a=findAcc(id);
  if(!a){ $("loginMsg").textContent="الحساب غير موجود."; return; }

  const h=await sha256(pin);
  if(h!==a.pinHash){ $("loginMsg").textContent="PIN غلط."; return; }

  setSession({id:a.id});
  setManagedId(a.id);
  $("loginPin").value="";

  showTabs();
  go("profile");
}
function logout(){
  clearSession();
  localStorage.removeItem("ws_managed_id");
  showLogin();
}
function resetAll(){
  if(!confirm("Reset ALL data? This will delete all accounts and logs.")) return;
  localStorage.clear();
  location.reload();
}

/* =================== Profile =================== */
function renderProfile(){
  const a=me();
  if(!a){ showLogin(); return; }

  $("profileCoach").classList.toggle("hidden", !(isAdmin()||isCoach()));
  $("profileSub").classList.toggle("hidden", !isSub());

  if(isSub()){
    // force managed self
    if(getManagedId()!==a.id) setManagedId(a.id);
    loadSubscriberResults();
    return;
  }

  // Coach/Admin
  fillManagedSelect();
  fillCoachMySubsList();
  $("managedMsg").textContent = "";
  $("myPinMsg").textContent = "";
  $("cSubMsg").textContent = "";
  $("cSubOpsMsg").textContent = "";
}
function fillManagedSelect(){
  const a=me();
  const acc=loadAccounts();
  const sel=$("managedSel");
  sel.innerHTML="";

  let list=[];
  if(isAdmin()){
    list = acc.filter(x=>x.role!=="admin").concat(acc.filter(x=>x.role==="admin")); // include admin too
    // ensure admin first maybe
    list = acc; // simpler: all accounts
  } else {
    // coach: self + own subs
    list = [a, ...acc.filter(x=>x.role==="subscriber" && x.coachId===a.id)];
  }

  list.forEach(x=>{
    const opt=document.createElement("option");
    opt.value=x.id;
    opt.textContent = `${x.name} (${x.role})`;
    sel.appendChild(opt);
  });
  if(getManagedId()) sel.value=getManagedId();
}
function setManaged(){
  const id=$("managedSel").value;
  const a=me();
  const target=findAcc(id);
  if(!target) return;

  if(!isAdmin()){
    // coach restrictions
    if(target.role==="coach" && target.id!==a.id){ $("managedMsg").textContent="غير مسموح."; return; }
    if(target.role==="subscriber" && target.coachId!==a.id){ $("managedMsg").textContent="غير مسموح."; return; }
  }

  setManagedId(id);
  $("managedMsg").textContent = `✅ Managing: ${target.name}`;
  hydrateHeader();
}
async function changeMyPin(){
  $("myPinMsg").textContent="";
  const a=me(); if(!a){ $("myPinMsg").textContent="No session."; return; }
  const pin=($("myNewPin").value||"").trim();
  if(!PIN_RE.test(pin)){ $("myPinMsg").textContent="PIN لازم 6 أرقام."; return; }

  const acc=loadAccounts();
  const i=acc.findIndex(x=>x.id===a.id);
  acc[i].pinHash = await sha256(pin);
  saveAccounts(acc);
  $("myNewPin").value="";
  $("myPinMsg").innerHTML=`<span class="ok">✅ Updated.</span>`;
  renderLoginList();
}

/* Coach subscriber tools */
function fillCoachMySubsList(){
  if(!(isCoach()||isAdmin())) return;
  const a=me();
  const acc=loadAccounts();
  const list = isAdmin() ? acc.filter(x=>x.role==="subscriber") : acc.filter(x=>x.role==="subscriber" && x.coachId===a.id);
  const sel=$("cMySubsSel");
  sel.innerHTML="";
  if(!list.length){
    const opt=document.createElement("option"); opt.value=""; opt.textContent="No subscribers";
    sel.appendChild(opt); return;
  }
  list.forEach(s=>{
    const opt=document.createElement("option");
    opt.value=s.id;
    opt.textContent = `${s.name} (Coach: ${findAcc(s.coachId)?.name||"—"})`;
    sel.appendChild(opt);
  });
}
async function coachAddSubscriber(){
  $("cSubMsg").textContent="";
  const a=me();
  if(!isCoach()){ $("cSubMsg").textContent="Coach فقط."; return; }

  const name=($("cSubName").value||"").trim().slice(0,30);
  const pin=($("cSubPin").value||"").trim();
  if(!name){ $("cSubMsg").textContent="اكتب اسم."; return; }
  if(!PIN_RE.test(pin)){ $("cSubMsg").textContent="PIN 6 أرقام."; return; }

  const acc=loadAccounts();
  acc.push({id:uid(),name,role:"subscriber",coachId:a.id,pinHash:await sha256(pin)});
  saveAccounts(acc);

  $("cSubName").value=""; $("cSubPin").value="";
  $("cSubMsg").innerHTML=`<span class="ok">✅ Added.</span>`;
  renderLoginList();
  fillManagedSelect();
  fillCoachMySubsList();
}
async function coachResetSubPin(){
  $("cSubOpsMsg").textContent="";
  const a=me();
  if(!isCoach()){ $("cSubOpsMsg").textContent="Coach فقط."; return; }
  const subId=$("cMySubsSel").value;
  const newPin=($("cResetPin").value||"").trim();
  if(!subId){ $("cSubOpsMsg").textContent="اختر مشترك."; return; }
  if(!PIN_RE.test(newPin)){ $("cSubOpsMsg").textContent="PIN 6 أرقام."; return; }

  const sub=findAcc(subId);
  if(!sub || sub.role!=="subscriber" || sub.coachId!==a.id){ $("cSubOpsMsg").textContent="غير مسموح."; return; }

  const acc=loadAccounts();
  const i=acc.findIndex(x=>x.id===subId);
  acc[i].pinHash = await sha256(newPin);
  saveAccounts(acc);

  $("cResetPin").value="";
  $("cSubOpsMsg").innerHTML=`<span class="ok">✅ Reset.</span>`;
  renderLoginList();
}
function coachDeleteSub(){
  $("cSubOpsMsg").textContent="";
  const a=me();
  if(!isCoach()){ $("cSubOpsMsg").textContent="Coach فقط."; return; }

  const subId=$("cMySubsSel").value;
  if(!subId){ $("cSubOpsMsg").textContent="اختر مشترك."; return; }

  const sub=findAcc(subId);
  if(!sub || sub.role!=="subscriber" || sub.coachId!==a.id){ $("cSubOpsMsg").textContent="غير مسموح."; return; }
  if(!confirm(`Delete subscriber: ${sub.name}?`)) return;

  saveAccounts(loadAccounts().filter(x=>x.id!==subId));
  if(getManagedId()===subId) setManagedId(a.id);

  $("cSubOpsMsg").innerHTML=`<span class="ok">✅ Deleted.</span>`;
  renderLoginList();
  fillManagedSelect();
  fillCoachMySubsList();
  hydrateHeader();
}

/* =================== Calculator =================== */
function initCalcDropdowns(){
  $("weight").innerHTML=""; $("height").innerHTML=""; $("age").innerHTML="";
  for(let i=30;i<=200;i++){
    const o=document.createElement("option"); o.value=i; o.textContent=`${i} kg`;
    if(i===80) o.selected=true; $("weight").appendChild(o);
  }
  for(let i=130;i<=210;i++){
    const o=document.createElement("option"); o.value=i; o.textContent=`${i} cm`;
    if(i===170) o.selected=true; $("height").appendChild(o);
  }
  for(let i=14;i<=80;i++){
    const o=document.createElement("option"); o.value=i; o.textContent=`${i} years`;
    if(i===30) o.selected=true; $("age").appendChild(o);
  }
}
function saveCalcInputs(){
  const data={
    weight:$("weight").value, height:$("height").value, age:$("age").value,
    gender:$("gender").value, activityDays:$("activityDays").value,
    goal:$("goal").value, proteinFactor:$("proteinFactor").value,
    meals:$("meals").value, weeklyGoal:$("weeklyGoal").value
  };
  pset("calc_inputs", JSON.stringify(data));
}
function loadCalcInputs(){
  const raw=pget("calc_inputs");
  if(!raw) return;
  try{
    const d=JSON.parse(raw);
    Object.keys(d).forEach(k=>{ if($(k)) $(k).value=d[k]; });
  }catch{}
}
function storeCalcResults(obj){
  pset("calc_results", JSON.stringify(obj));
  pset("weekly_target", String(obj.weeklyTarget));
}
function loadCalcResults(){
  const raw=pget("calc_results");
  if(!raw) return null;
  try{return JSON.parse(raw);}catch{return null;}
}
function renderCalcMode(){
  if(isSub()){
    $("calcInputsWrap").classList.add("hidden");
    $("calcHint").textContent="Subscriber: Results only.";
  } else {
    $("calcInputsWrap").classList.remove("hidden");
    $("calcHint").textContent = canEditEverything()
      ? "Coach/Admin: edit and Calculate to save for managed profile."
      : "Read-only (not allowed for this managed profile).";
    // disable inputs if not allowed
    const fields=["weight","height","age","gender","activityDays","goal","proteinFactor","meals","weeklyGoal"];
    fields.forEach(id=>{ $(id).disabled = !canEditEverything(); $(id).style.opacity = $(id).disabled ? .75 : 1; });
    $("calcBtn").disabled = !canEditEverything();
    $("calcBtn").style.opacity = $("calcBtn").disabled ? .75 : 1;
  }
}
function renderCalcResults(){
  const r=loadCalcResults();
  if(!r){
    $("outCalories").textContent="Daily Calories: --";
    $("outMacros").textContent="Protein/Carbs/Fat: --";
    $("outPerMeal").textContent="Per Meal: --";
    $("outBurn").textContent="Daily Burn Target: --";
    return;
  }
  $("outCalories").textContent = `Daily Calories: ${r.calories} kcal`;
  $("outMacros").innerHTML = `Protein: ${r.protein} g<br>Carbs: ${r.carbs} g<br>Fat: ${r.fat} g`;
  $("outPerMeal").innerHTML =
    `Per Meal (${r.meals} meals):<br><br>`+
    `Protein: ${r.proteinMeal} g ≈ ${r.chickenGrams} g chicken<br>`+
    `Carbs: ${r.carbsMeal} g ≈ ${r.riceGrams} g rice<br>`+
    `Fat: ${r.fatMeal} g ≈ ${r.oilGrams} g oil`;
  $("outBurn").textContent = `Daily Burn Target: ${r.dailyBurn} kcal`;
}
async function calcAndSave(){
  if(!canEditEverything()) { renderCalcResults(); return; }

  const weight=parseFloat($("weight").value);
  const height=parseFloat($("height").value);
  const age=parseFloat($("age").value);
  const gender=$("gender").value;
  const activityDays=parseInt($("activityDays").value,10);
  const goal=$("goal").value;
  const proteinFactor=parseFloat($("proteinFactor").value);
  const meals=parseInt($("meals").value,10);
  const weeklyGoalKg=parseFloat($("weeklyGoal").value);

  const bmr = (gender==="male")
    ? (10*weight + 6.25*height - 5*age + 5)
    : (10*weight + 6.25*height - 5*age - 161);

  let activityMult = 1.2 + (activityDays - 1)*0.1;
  if(activityMult>1.9) activityMult=1.9;

  let calories = bmr * activityMult;
  if(goal==="cut") calories -= 500;
  if(goal==="bulk") calories += 500;

  const protein = weight * proteinFactor;
  const fat = weight * 0.8;
  const carbs = (calories - (protein*4 + fat*9))/4;

  const proteinMeal = protein/meals;
  const carbsMeal = carbs/meals;
  const fatMeal = fat/meals;

  // simple “scale” approximations
  const chickenGrams = proteinMeal * 4;
  const riceGrams = carbsMeal * 3.5;
  const oilGrams = fatMeal;

  const weeklyTarget = weeklyGoalKg * 7700;
  const dailyBurn = weeklyTarget/7;

  const res={
    calories: Math.round(calories),
    protein: Math.round(protein),
    carbs: Math.round(carbs),
    fat: Math.round(fat),
    meals,
    proteinMeal: Math.round(proteinMeal),
    carbsMeal: Math.round(carbsMeal),
    fatMeal: Math.round(fatMeal),
    chickenGrams: Math.round(chickenGrams),
    riceGrams: Math.round(riceGrams),
    oilGrams: Math.round(oilGrams),
    weeklyTarget: Math.round(weeklyTarget),
    dailyBurn: Math.round(dailyBurn)
  };

  saveCalcInputs();
  storeCalcResults(res);
  renderCalcResults();
  syncWeeklyTarget();
}
$("calcBtn").addEventListener("click", calcAndSave);

function loadSubscriberResults(){
  const r=loadCalcResults();
  if(!r){
    $("subWarn").textContent="⚠️ المدرب لم يحفظ نتائج الحاسبة لك بعد.";
    $("subCal").textContent="Daily Calories: --";
    $("subMacros").textContent="Protein/Carbs/Fat: --";
    $("subPerMeal").textContent="Per Meal: --";
    $("subBurn").textContent="Daily Burn Target: --";
    return;
  }
  $("subWarn").textContent="";
  $("subCal").textContent=`Daily Calories: ${r.calories} kcal`;
  $("subMacros").innerHTML=`Protein: ${r.protein} g<br>Carbs: ${r.carbs} g<br>Fat: ${r.fat} g`;
  $("subPerMeal").innerHTML=
    `Per Meal (${r.meals} meals):<br><br>`+
    `Protein: ${r.proteinMeal} g ≈ ${r.chickenGrams} g chicken<br>`+
    `Carbs: ${r.carbsMeal} g ≈ ${r.riceGrams} g rice<br>`+
    `Fat: ${r.fatMeal} g ≈ ${r.oilGrams} g oil`;
  $("subBurn").textContent=`Daily Burn Target: ${r.dailyBurn} kcal`;
}

/* =================== Weekly burn =================== */
function buildWeekInputs(){
  const grid=$("daysGrid");
  if(grid.dataset.built==="1") return;
  grid.innerHTML="";
  for(let d=1; d<=7; d++){
    const wrap=document.createElement("div");
    const lbl=document.createElement("label");
    lbl.textContent=`Day ${d} burned (kcal)`;
    lbl.style.marginTop="0";
    const inp=document.createElement("input");
    inp.type="number"; inp.min="0"; inp.step="10"; inp.id=`day_${d}`; inp.placeholder="0";
    inp.addEventListener("input", ()=>{
      pset(`day_${d}`, inp.value||"");
      recalcWeek();
    });
    wrap.appendChild(lbl); wrap.appendChild(inp);
    grid.appendChild(wrap);
  }
  $("todayIndex").addEventListener("change", ()=>{
    pset("today_index", $("todayIndex").value);
    recalcWeek();
  });
  grid.dataset.built="1";
}
function loadWeekInputs(){
  for(let d=1; d<=7; d++){
    const v=pget(`day_${d}`)||"";
    const el=$(`day_${d}`); if(el) el.value=v;
  }
  const ti=pget("today_index"); if(ti) $("todayIndex").value=ti;
}
function getWeeklyTarget(){
  const v=pget("weekly_target");
  const n=parseFloat(v||"0");
  return isFinite(n)?n:0;
}
function syncWeeklyTarget(){
  const t=getWeeklyTarget();
  $("weeklyTargetLabel").textContent = `Weekly target burn: ${t>0?Math.round(t):"--"} kcal`;
}
function recalcWeek(){
  const target=getWeeklyTarget();
  if(target<=0){
    $("wkWarn").textContent="⚠️ لازم المدرب يحفظ هدف الأسبوع من الحاسبة.";
    $("wkBurned").textContent="Burned so far: --";
    $("wkRemaining").textContent="Remaining: --";
    $("wkPerDay").textContent="Required per remaining day: --";
    $("wkTomorrow").textContent="Tomorrow target: --";
    return;
  } else $("wkWarn").textContent="";

  let burned=0;
  for(let d=1; d<=7; d++){
    const val=parseFloat(($(`day_${d}`).value||"").trim());
    if(isFinite(val) && val>0) burned += val;
  }
  const remaining=Math.max(0, target-burned);
  const today=parseInt($("todayIndex").value,10);
  const remDays=Math.max(0, 7-today);
  const perDay = remDays>0 ? (remaining/remDays) : remaining;

  $("wkBurned").textContent=`Burned so far: ${Math.round(burned)} kcal`;
  $("wkRemaining").textContent=`Remaining to reach target: ${Math.round(remaining)} kcal`;
  $("wkPerDay").textContent = remDays>0
    ? `Required per day for remaining days (${remDays}): ${Math.round(perDay)} kcal/day`
    : `Week finished. Remaining: ${Math.round(remaining)} kcal`;
  $("wkTomorrow").textContent = `Tomorrow target: ${remDays>0?Math.round(perDay):0} kcal`;
}
function applyWeekButtons(){
  $("weekResetBtn").classList.toggle("hidden", !canEditEverything());
}
function resetWeek(){
  if(!canEditEverything()) return;
  if(!confirm("Reset week logs for this profile?")) return;
  for(let d=1; d<=7; d++){ premove(`day_${d}`); $(`day_${d}`).value=""; }
  premove("today_index"); $("todayIndex").value="1";
  recalcWeek();
}

/* =================== Workouts =================== */
const weekDays = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
function defaultWorkouts(){ const o={}; weekDays.forEach(d=>o[d]=[]); return o; }
function loadWorkouts(){
  const raw=pget("workouts");
  if(!raw) return defaultWorkouts();
  try{
    const d=JSON.parse(raw);
    weekDays.forEach(day=>{ if(!Array.isArray(d[day])) d[day]=[]; });
    return d;
  }catch{return defaultWorkouts();}
}
function saveWorkouts(d){ pset("workouts", JSON.stringify(d)); }
function toggleDay(day){
  const key="open_"+day;
  const open = (pget(key)==="1") ? "0" : "1";
  pset(key, open);
  renderWorkouts();
}
function addExercise(day){
  if(!canEditEverything()) return;
  const d=loadWorkouts();
  d[day].push({name:"", sets:3, maxWeight:0});
  saveWorkouts(d); renderWorkouts();
}
function delExercise(day, idx){
  if(!canEditEverything()) return;
  const d=loadWorkouts();
  d[day].splice(idx,1);
  saveWorkouts(d); renderWorkouts();
}
function updateEx(day, idx, key, val){
  const d=loadWorkouts();
  if(!d[day] || !d[day][idx]) return;

  if(canEditEverything()){
    d[day][idx][key]=val;
    saveWorkouts(d);
    return;
  }
  // subscriber: maxWeight only
  if(canEditMaxWeightOnly() && key==="maxWeight"){
    d[day][idx].maxWeight=val;
    saveWorkouts(d);
  }
}
function renderWorkouts(){
  const wrap=$("workContainer");
  wrap.innerHTML="";
  const d=loadWorkouts();

  weekDays.forEach(day=>{
    const card=document.createElement("div"); card.className="day-card";
    const head=document.createElement("div"); head.className="day-head"; head.onclick=()=>toggleDay(day);
    const nm=document.createElement("div"); nm.className="day-name"; nm.textContent=day;
    const chev=document.createElement("div"); chev.textContent = (pget("open_"+day)==="1") ? "▲" : "▼";
    head.appendChild(nm); head.appendChild(chev);
    card.appendChild(head);

    const open = (pget("open_"+day)==="1");
    if(open){
      if(canEditEverything()){
        const btn=document.createElement("button");
        btn.className="mini"; btn.textContent="+ Add Exercise";
        btn.onclick=(e)=>{ e.stopPropagation(); addExercise(day); };
        card.appendChild(btn);
      }

      if(d[day].length===0){
        const empty=document.createElement("div");
        empty.className="small muted"; empty.textContent="No exercises yet.";
        card.appendChild(empty);
      }else{
        d[day].forEach((ex, idx)=>{
          const row=document.createElement("div"); row.className="exercise";

          const name=document.createElement("input");
          name.className="exercise-name";
          name.placeholder="Exercise";
          name.value=ex.name||"";
          name.oninput=(e)=>updateEx(day, idx, "name", e.target.value);
          name.disabled = !canEditEverything();
          name.style.opacity = name.disabled ? .75 : 1;

          const sets=document.createElement("div"); sets.className="counter";
          const sm=document.createElement("button"); sm.textContent="-";
          sm.onclick=()=>{ const cur=parseInt(ex.sets||3,10); if(cur>1){ updateEx(day,idx,"sets",cur-1); renderWorkouts(); } };
          sm.disabled=!canEditEverything(); sm.style.opacity=sm.disabled?.75:1;
          const sv=document.createElement("span"); sv.textContent=`S:${parseInt(ex.sets||3,10)}`;
          const sp=document.createElement("button"); sp.textContent="+";
          sp.onclick=()=>{ const cur=parseInt(ex.sets||3,10); updateEx(day,idx,"sets",cur+1); renderWorkouts(); };
          sp.disabled=!canEditEverything(); sp.style.opacity=sp.disabled?.75:1;
          sets.appendChild(sm); sets.appendChild(sv); sets.appendChild(sp);

          const wt=document.createElement("div"); wt.className="counter";
          const wm=document.createElement("button"); wm.textContent="-";
          wm.onclick=()=>{ let w=parseFloat(ex.maxWeight||0); if(!isFinite(w)) w=0; w=Math.max(0,w-2.5); updateEx(day,idx,"maxWeight",w); renderWorkouts(); };
          wm.disabled=!canEditMaxWeight(); wm.style.opacity=wm.disabled?.75:1;
          const wv=document.createElement("span"); wv.textContent=`W:${(parseFloat(ex.maxWeight||0)||0)}kg`;
          const wp=document.createElement("button"); wp.textContent="+";
          wp.onclick=()=>{ let w=parseFloat(ex.maxWeight||0); if(!isFinite(w)) w=0; w=w+2.5; updateEx(day,idx,"maxWeight",w); renderWorkouts(); };
          wp.disabled=!canEditMaxWeight(); wp.style.opacity=wp.disabled?.75:1;
          wt.appendChild(wm); wt.appendChild(wv); wt.appendChild(wp);

          row.appendChild(name);
          row.appendChild(sets);
          row.appendChild(wt);

          if(canEditEverything()){
            const del=document.createElement("button");
            del.className="delbtn";
            del.textContent="X";
            del.onclick=()=>delExercise(day, idx);
            row.appendChild(del);
          }

          card.appendChild(row);
        });
      }
    }

    wrap.appendChild(card);
  });

  $("workHint").textContent = canEditEverything()
    ? "Coach/Admin: edit exercises, sets, max weight."
    : "Subscriber: you can edit Max Weight only.";

}
function applyWorkButtons(){
  $("workResetBtn").classList.toggle("hidden", !canEditEverything());
}
function resetWorkouts(){
  if(!canEditEverything()) return;
  if(!confirm("Reset workouts for this profile?")) return;
  premove("workouts");
  weekDays.forEach(d=>premove("open_"+d));
  renderWorkouts();
}

/* =================== Weight tracker =================== */
function initWeightWeeks(){
  const sel=$("weightWeeks");
  sel.innerHTML="";
  for(let w=4; w<=52; w++){
    const o=document.createElement("option"); o.value=String(w); o.textContent=`${w} weeks`;
    if(w===12) o.selected=true;
    sel.appendChild(o);
  }
  sel.addEventListener("change", ()=>{
    pset("weight_weeks", sel.value);
    renderWeightRows();
    calcWeightSummary();
  });
}
function getWeightWeeks(){
  const saved=pget("weight_weeks");
  const n=parseInt(saved || $("weightWeeks").value || "12",10);
  return Math.max(4, Math.min(52, isFinite(n)?n:12));
}
function loadWeightTracker(){
  const saved=pget("weight_weeks");
  if(saved) $("weightWeeks").value=saved;
  renderWeightRows();
  calcWeightSummary();
}
function renderWeightRows(){
  const weeks=getWeightWeeks();
  const wrap=$("weightRows");
  wrap.innerHTML="";
  for(let i=1;i<=weeks;i++){
    const row=document.createElement("div"); row.className="wrow";
    const tag=document.createElement("div"); tag.className="wtag"; tag.textContent=`Week ${i}`;
    const inp=document.createElement("input");
    inp.type="number"; inp.min="0"; inp.step="0.1"; inp.placeholder="Weight (kg)";
    inp.value = pget("w_"+i) || "";
    inp.addEventListener("input", ()=>{
      pset("w_"+i, inp.value||"");
      calcWeightSummary();
    });
    row.appendChild(tag); row.appendChild(inp);
    wrap.appendChild(row);
  }
}
function calcWeightSummary(){
  const weeks=getWeightWeeks();
  let start=null, last=null, lastIdx=null;
  for(let i=1;i<=weeks;i++){
    const v=parseFloat((pget("w_"+i)||"").trim());
    if(isFinite(v) && v>0){
      if(start===null) start=v;
      last=v; lastIdx=i;
    }
  }
  if(start===null || last===null){
    $("wStart").textContent="Start: --";
    $("wCurrent").textContent="Current: --";
    $("wChange").textContent="Change: --";
    $("wAvg").textContent="Avg / Week: --";
    return;
  }
  const change=last-start;
  const weeksPassed=Math.max(1, (lastIdx-1));
  const avg=change/weeksPassed;

  $("wStart").textContent=`Start: ${start.toFixed(1)} kg`;
  $("wCurrent").textContent=`Current: ${last.toFixed(1)} kg (Week ${lastIdx})`;
  $("wChange").textContent=`Change: ${change.toFixed(1)} kg`;
  $("wAvg").textContent=`Avg / Week: ${avg.toFixed(2)} kg/week`;
}
function applyWeightButtons(){
  $("weightResetBtn").classList.toggle("hidden", !canEditEverything());
}
function resetWeight(){
  if(!canEditEverything()) return;
  if(!confirm("Reset weight log for this profile?")) return;
  const weeks=getWeightWeeks();
  for(let i=1;i<=weeks;i++) premove("w_"+i);
  renderWeightRows();
  calcWeightSummary();
}

/* =================== Admin panel =================== */
function renderAdminPanel(){
  if(!isAdmin()){ go("profile"); return; }

  $("adminPinMsg").textContent="";
  $("aCoachMsg").textContent="";
  $("aCoachResetMsg").textContent="";
  $("aCoachDelMsg").textContent="";
  $("aSubMsg").textContent="";

  fillAdminLists();
}
function fillAdminLists(){
  const acc=loadAccounts();
  const coaches=acc.filter(x=>x.role==="coach");
  const subs=acc.filter(x=>x.role==="subscriber");

  const coachSel=$("aCoachSel");
  const moveSel=$("aMoveToCoach");
  coachSel.innerHTML=""; moveSel.innerHTML="";

  if(!coaches.length){
    const o=document.createElement("option"); o.value=""; o.textContent="No coaches";
    coachSel.appendChild(o);
    const o2=document.createElement("option"); o2.value=""; o2.textContent="No coaches";
    moveSel.appendChild(o2);
  }else{
    coaches.forEach(c=>{
      const o=document.createElement("option"); o.value=c.id; o.textContent=c.name;
      coachSel.appendChild(o);
      const o2=document.createElement("option"); o2.value=c.id; o2.textContent=c.name;
      moveSel.appendChild(o2);
    });
  }

  const subSel=$("aSubSel");
  subSel.innerHTML="";
  if(!subs.length){
    const o=document.createElement("option"); o.value=""; o.textContent="No subscribers";
    subSel.appendChild(o);
  }else{
    subs.forEach(s=>{
      const o=document.createElement("option");
      o.value=s.id;
      o.textContent=`${s.name} (Coach: ${findAcc(s.coachId)?.name||"—"})`;
      subSel.appendChild(o);
    });
  }
}
async function changeAdminPin(){
  $("adminPinMsg").textContent="";
  const pin=($("adminNewPin").value||"").trim();
  if(!PIN_RE.test(pin)){ $("adminPinMsg").textContent="PIN لازم 6 أرقام."; return; }

  const acc=loadAccounts();
  const i=acc.findIndex(x=>x.role==="admin");
  acc[i].pinHash = await sha256(pin);
  saveAccounts(acc);

  $("adminNewPin").value="";
  $("adminPinMsg").innerHTML=`<span class="ok">✅ Admin PIN updated.</span>`;
  renderLoginList();
}
async function adminCreateCoach(){
  $("aCoachMsg").textContent="";
  const name=($("aCoachName").value||"").trim().slice(0,30);
  const pin=($("aCoachPin").value||"").trim();
  if(!name){ $("aCoachMsg").textContent="اكتب اسم المدرب."; return; }
  if(!PIN_RE.test(pin)){ $("aCoachMsg").textContent="PIN 6 أرقام."; return; }

  const acc=loadAccounts();
  acc.push({id:uid(), name, role:"coach", pinHash: await sha256(pin)});
  saveAccounts(acc);

  $("aCoachName").value=""; $("aCoachPin").value="";
  $("aCoachMsg").innerHTML=`<span class="ok">✅ Coach created.</span>`;
  renderLoginList();
  fillAdminLists();
  fillManagedSelect();
}
async function adminResetCoachPin(){
  $("aCoachResetMsg").textContent="";
  const id=$("aCoachSel").value;
  const pin=($("aCoachResetPin").value||"").trim();
  if(!id){ $("aCoachResetMsg").textContent="اختر مدرب."; return; }
  if(!PIN_RE.test(pin)){ $("aCoachResetMsg").textContent="PIN 6 أرقام."; return; }

  const acc=loadAccounts();
  const i=acc.findIndex(x=>x.id===id && x.role==="coach");
  if(i<0){ $("aCoachResetMsg").textContent="Coach غير موجود."; return; }

  acc[i].pinHash = await sha256(pin);
  saveAccounts(acc);

  $("aCoachResetPin").value="";
  $("aCoachResetMsg").innerHTML=`<span class="ok">✅ Coach PIN reset.</span>`;
  renderLoginList();
}
function adminDeleteCoach(cascade){
  $("aCoachDelMsg").textContent="";
  const id=$("aCoachSel").value;
  if(!id){ $("aCoachDelMsg").textContent="اختر مدرب."; return; }
  const target=findAcc(id);
  if(!target || target.role!=="coach"){ $("aCoachDelMsg").textContent="Coach غير موجود."; return; }

  const acc=loadAccounts();
  const subs=acc.filter(x=>x.role==="subscriber" && x.coachId===id);

  if(!cascade && subs.length>0){
    $("aCoachDelMsg").textContent=`لا يمكن حذف المدرب لأنه لديه ${subs.length} مشتركين. استخدم Cascade.`;
    return;
  }
  if(!confirm(`Delete coach: ${target.name}? ${cascade?"AND all subscribers":""}`)) return;

  let next = acc.filter(x=>x.id!==id);
  if(cascade){
    next = next.filter(x=>!(x.role==="subscriber" && x.coachId===id));
  }
  saveAccounts(next);

  // if managed now points to deleted, set managed to admin
  if(getManagedId()===id) setManagedId(me().id);

  $("aCoachDelMsg").innerHTML=`<span class="ok">✅ Deleted.</span>`;
  renderLoginList();
  fillAdminLists();
  fillManagedSelect();
}
async function adminResetSubPin(){
  $("aSubMsg").textContent="";
  const id=$("aSubSel").value;
  const pin=($("aSubResetPin").value||"").trim();
  if(!id){ $("aSubMsg").textContent="اختر مشترك."; return; }
  if(!PIN_RE.test(pin)){ $("aSubMsg").textContent="PIN 6 أرقام."; return; }

  const acc=loadAccounts();
  const i=acc.findIndex(x=>x.id===id && x.role==="subscriber");
  if(i<0){ $("aSubMsg").textContent="Subscriber غير موجود."; return; }

  acc[i].pinHash = await sha256(pin);
  saveAccounts(acc);

  $("aSubResetPin").value="";
  $("aSubMsg").innerHTML=`<span class="ok">✅ Subscriber PIN reset.</span>`;
  renderLoginList();
}
function adminMoveSubscriber(){
  $("aSubMsg").textContent="";
  const subId=$("aSubSel").value;
  const coachId=$("aMoveToCoach").value;
  if(!subId){ $("aSubMsg").textContent="اختر مشترك."; return; }
  if(!coachId){ $("aSubMsg").textContent="اختر مدرب."; return; }

  const acc=loadAccounts();
  const i=acc.findIndex(x=>x.id===subId && x.role==="subscriber");
  const c=acc.find(x=>x.id===coachId && x.role==="coach");
  if(i<0 || !c){ $("aSubMsg").textContent="بيانات غير صحيحة."; return; }

  acc[i].coachId = coachId;
  saveAccounts(acc);

  $("aSubMsg").innerHTML=`<span class="ok">✅ Moved subscriber.</span>`;
  fillAdminLists();
  renderLoginList();
}
function adminDeleteSubscriber(){
  $("aSubMsg").textContent="";
  const id=$("aSubSel").value;
  if(!id){ $("aSubMsg").textContent="اختر مشترك."; return; }

  const sub=findAcc(id);
  if(!sub || sub.role!=="subscriber"){ $("aSubMsg").textContent="Subscriber غير موجود."; return; }
  if(!confirm(`Delete subscriber: ${sub.name}?`)) return;

  saveAccounts(loadAccounts().filter(x=>x.id!==id));
  if(getManagedId()===id) setManagedId(me().id);

  $("aSubMsg").innerHTML=`<span class="ok">✅ Deleted subscriber.</span>`;
  fillAdminLists();
  renderLoginList();
  fillManagedSelect();
}

/* =================== Init =================== */
(async function init(){
  await ensureAdmin();
  initCalcDropdowns();
  initWeightWeeks();
  renderLoginList();

  const s=getSession();
  if(!s){ showLogin(); return; }

  showTabs();
  hydrateHeader();

  // if subscriber, force managed self
  const a=me();
  if(a && a.role==="subscriber") setManagedId(a.id);

  go("profile");
})();
</script>
</body>
</html>
